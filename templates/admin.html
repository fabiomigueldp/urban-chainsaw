<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Signal Processor - Admin Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bs-primary: #0d6efd;
            --bs-success: #198754;
            --bs-warning: #ffc107;
            --bs-danger: #dc3545;
            --bs-info: #0dcaf0;
            --bs-dark: #212529;
            --bs-light: #f8f9fa;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .status-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: var(--bs-success);
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background-color: var(--bs-danger);
        }
        
        .status-paused {
            background-color: var(--bs-warning);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .audit-table {
            font-size: 0.875rem;
        }
        
        .badge-status {
            font-size: 0.75rem;
        }
        
        .refresh-btn {
            transition: transform 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: rotate(180deg);
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 200px;
        }
        
        .filter-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 20px;
        }
        
        .section-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .action-buttons .btn {
            margin: 0 5px 10px 0;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .table-responsive {
            max-height: 500px;
        }
        
        .progress-container {
            margin: 10px 0;
        }
        
        .alert-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1040;
            max-width: 400px;
        }
        
        .sell-all-ticker {
            margin: 2px;
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 0.875rem;
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- Connection Status Alert -->
    <div id="connectionStatus" class="connection-status">
        <div class="alert alert-info alert-dismissible" role="alert">
            <i class="bi bi-wifi"></i> Conectando ao servidor...
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
    
    <!-- Alert Container -->
    <div id="alertContainer" class="alert-container"></div>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up-arrow"></i>
                Trading Signal Processor
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span id="connectionIndicator" class="status-indicator status-offline"></span>
                    <span id="connectionText">Desconectado</span>
                </span>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-primary" id="signalsReceived">-</div>
                        <div class="metric-label">Sinais Recebidos</div>
                        <small class="text-muted">Total desde início</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-success" id="signalsApproved">-</div>
                        <div class="metric-label">Sinais Aprovados</div>
                        <small class="text-muted">Passou no filtro Top-N</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-warning" id="signalsRejected">-</div>
                        <div class="metric-label">Sinais Rejeitados</div>
                        <small class="text-muted">Não passou no filtro</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-info" id="signalsForwarded">-</div>
                        <div class="metric-label">Sinais Encaminhados</div>
                        <small class="text-muted">Enviados com sucesso</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Queue Status and System Info -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-queue"></i> Status das Filas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="metric-value text-primary" id="processingQueueSize">-</div>
                                <div class="metric-label">Fila de Processamento</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value text-warning" id="approvedQueueSize">-</div>
                                <div class="metric-label">Fila de Encaminhamento</div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="d-flex justify-content-between small">
                                <span>Workers Ativos:</span>
                                <span id="forwardingWorkersActive">-</span>
                            </div>
                            <div class="progress">
                                <div id="workerProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle"></i> Sistema
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <strong>Engine Status:</strong><br>
                                <span id="engineStatus" class="badge badge-status">-</span>
                            </div>
                            <div class="col-6">
                                <strong>Rate Limiter:</strong><br>
                                <span id="rateLimiterStatus" class="badge badge-status">-</span>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>Tickers Top-N:</strong><br>
                                <span id="tickerCount">-</span>
                            </div>
                            <div class="col-6">
                                <strong>Uptime:</strong><br>
                                <span id="uptime">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-bar-chart"></i> Sinais por Hora
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="signalsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-pie-chart"></i> Taxa de Aprovação
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="approvalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Control Actions -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-gear"></i> Controles do Sistema
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="action-buttons">
                            <button id="pauseEngineBtn" class="btn btn-warning">
                                <i class="bi bi-pause"></i> Pausar Engine
                            </button>
                            <button id="resumeEngineBtn" class="btn btn-success">
                                <i class="bi bi-play"></i> Retomar Engine
                            </button>
                            <button id="refreshEngineBtn" class="btn btn-info">
                                <i class="bi bi-arrow-clockwise refresh-btn"></i> Atualizar Tickers
                            </button>
                            <button id="resetMetricsBtn" class="btn btn-secondary">
                                <i class="bi bi-arrow-counterclockwise"></i> Resetar Métricas
                            </button>
                            <button id="pauseRateLimiterBtn" class="btn btn-warning">
                                <i class="bi bi-pause"></i> Pausar Rate Limiter
                            </button>
                            <button id="resumeRateLimiterBtn" class="btn btn-success">
                                <i class="bi bi-play"></i> Retomar Rate Limiter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-gear-fill"></i> Configurações
                        </h5>
                    </div>
                    <div class="card-body">
                        <button id="openConfigBtn" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-sliders"></i> Abrir Painel de Configurações
                        </button>
                        <button id="setTokenBtn" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-key"></i> Configurar Token Admin
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Configuration Modal -->
        <div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="configModalLabel">
                            <i class="bi bi-gear-fill"></i> Configurações do Sistema
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- Webhook Configuration -->
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-send"></i> Webhook de Destino</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="webhookUrl" class="form-label">URL do Webhook:</label>
                                            <input type="url" id="webhookUrl" class="form-control" placeholder="https://webhook.example.com/endpoint">
                                        </div>
                                        <div class="mb-3">
                                            <label for="webhookTimeout" class="form-label">Timeout (segundos):</label>
                                            <input type="number" id="webhookTimeout" class="form-control" value="5" min="1" max="60">
                                        </div>
                                        <button id="updateWebhookBtn" class="btn btn-primary btn-sm">
                                            <i class="bi bi-check"></i> Atualizar Webhook
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Finviz Configuration -->
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-graph-up"></i> Configurações Finviz</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="finvizUrl" class="form-label">URL do Finviz:</label>
                                            <input type="url" id="finvizUrl" class="form-control">
                                        </div>
                                        <div class="mb-3">
                                            <label for="topN" class="form-label">Top-N Tickers:</label>
                                            <input type="number" id="topN" class="form-control" value="15" min="1" max="1000">
                                        </div>
                                        <div class="mb-3">
                                            <label for="refreshInterval" class="form-label">Intervalo de Atualização (seg):</label>
                                            <input type="number" id="refreshInterval" class="form-control" value="10" min="5" max="3600">
                                        </div>
                                        <button id="updateFinvizBtn" class="btn btn-primary btn-sm">
                                            <i class="bi bi-check"></i> Atualizar Finviz
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Rate Limiter Configuration -->
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-speedometer"></i> Rate Limiter</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="maxReqPerMin" class="form-label">Máx Req/Min:</label>
                                            <input type="number" id="maxReqPerMin" class="form-control" value="60" min="1" max="1000">
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="rateLimitingEnabled" checked>
                                            <label class="form-check-label" for="rateLimitingEnabled">
                                                Rate Limiting Habilitado
                                            </label>
                                        </div>
                                        <button id="updateRateLimiterBtn" class="btn btn-primary btn-sm">
                                            <i class="bi bi-check"></i> Atualizar Rate Limiter
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Token Configuration -->
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-key"></i> Token de Administração</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="adminToken" class="form-label">Token Atual:</label>
                                            <div class="input-group">
                                                <input type="password" id="adminToken" class="form-control" placeholder="Digite o token">
                                                <button class="btn btn-outline-secondary" type="button" id="toggleTokenVisibility">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="alert alert-info small">
                                            <i class="bi bi-info-circle"></i> Token será salvo no navegador para uso automático
                                        </div>
                                        <button id="saveTokenBtn" class="btn btn-success btn-sm">
                                            <i class="bi bi-save"></i> Salvar Token
                                        </button>
                                        <button id="clearTokenBtn" class="btn btn-outline-danger btn-sm">
                                            <i class="bi bi-trash"></i> Limpar Token
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button type="button" class="btn btn-primary" id="loadCurrentConfigBtn">
                            <i class="bi bi-arrow-clockwise"></i> Carregar Configuração Atual
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top-N Tickers List -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-star-fill"></i> Top-N Tickers Aprovados
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Lista Atual (<span id="topNTickerCount">0</span> tickers):</h6>
                            <button id="refreshTopNBtn" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                        <div id="topNTickers" class="mb-3" style="max-height: 200px; overflow-y: auto;">
                            <span class="text-muted">Carregando...</span>
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> 
                            Apenas sinais de tickers nesta lista serão aprovados e encaminhados
                        </small>
                        <div id="topNLastUpdate" class="mt-2">
                            <small class="text-muted">Última atualização: <span id="topNTimestamp">-</span></small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!-- Keep Sell All Management here -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-check"></i> Gerenciamento Sell All
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6>Tickers na Lista Sell All:</h6>
                            <div id="sellAllTickers" style="max-height: 150px; overflow-y: auto;">
                                <span class="text-muted">Carregando...</span>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button id="executeSellAllBtn" class="btn btn-danger">
                                <i class="bi bi-exclamation-triangle"></i> Executar Sell All
                            </button>
                            <button id="refreshSellAllBtn" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar Lista
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Audit Trail -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-journal-text"></i> Trilha de Auditoria
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="filter-card p-3 mb-3">
                            <div class="row">
                                <div class="col-md-2">
                                    <label for="limitSelect" class="form-label">Limite:</label>
                                    <select id="limitSelect" class="form-select form-select-sm">
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="1000">1000</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="statusFilter" class="form-label">Status:</label>
                                    <select id="statusFilter" class="form-select form-select-sm">
                                        <option value="">Todos</option>
                                        <option value="RECEIVED">Recebido</option>
                                        <option value="APPROVED">Aprovado</option>
                                        <option value="REJECTED">Rejeitado</option>
                                        <option value="FORWARDED_SUCCESS">Encaminhado</option>
                                        <option value="FORWARDED_HTTP_ERROR">Erro HTTP</option>
                                        <option value="ERROR">Erro</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="tickerFilter" class="form-label">Ticker:</label>
                                    <input type="text" id="tickerFilter" class="form-control form-control-sm" placeholder="Ex: AAPL">
                                </div>
                                <div class="col-md-2">
                                    <label for="signalIdFilter" class="form-label">Signal ID:</label>
                                    <input type="text" id="signalIdFilter" class="form-control form-control-sm" placeholder="Ex: c88c6d90">
                                </div>
                                <div class="col-md-2">
                                    <label for="hourFilter" class="form-label">Últimas horas:</label>
                                    <select id="hourFilter" class="form-select form-select-sm">
                                        <option value="">Todas</option>
                                        <option value="1">1 hora</option>
                                        <option value="6">6 horas</option>
                                        <option value="24">24 horas</option>
                                        <option value="168">7 dias</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button id="applyFiltersBtn" class="btn btn-primary btn-sm">
                                            <i class="bi bi-funnel"></i> Filtrar
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button id="clearFiltersBtn" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-x-circle"></i> Limpar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audit Table -->
                        <div class="table-responsive">
                            <table class="table table-hover table-sm audit-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Signal ID</th>
                                        <th>Ticker</th>
                                        <th>Status</th>
                                        <th>Localização</th>
                                        <th>Worker</th>
                                        <th>Detalhes</th>
                                        <th>HTTP</th>
                                    </tr>
                                </thead>
                                <tbody id="auditTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="loading-spinner spinner-border" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            Carregando dados da auditoria...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="text-muted">
                                <span id="auditResultsInfo">-</span>
                            </div>
                            <div>
                                <button id="prevPageBtn" class="btn btn-outline-secondary btn-sm me-2" disabled>
                                    <i class="bi bi-chevron-left"></i> Anterior
                                </button>
                                <span id="pageInfo" class="mx-2">Página 1</span>
                                <button id="nextPageBtn" class="btn btn-outline-secondary btn-sm ms-2" disabled>
                                    Próxima <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let socket = null;
        let signalsChart = null;
        let approvalChart = null;
        let currentPage = 1;
        let isLoading = false;
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            initializeCharts();
            loadInitialData();
            bindEventHandlers();
            
            // Auto-refresh audit trail every 30 seconds
            setInterval(loadAuditTrail, 30000);
        });
          // WebSocket connection
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/admin-updates`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function(event) {
                updateConnectionStatus(true);
                console.log('WebSocket connected');
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            socket.onclose = function(event) {
                updateConnectionStatus(false);
                console.log('WebSocket disconnected, attempting to reconnect...');
                // Attempt to reconnect every 5 seconds
                setTimeout(initializeWebSocket, 5000);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }
          // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'metrics_update':
                    updateMetrics(data.data);
                    break;
                case 'status_update':
                    // Handle comprehensive status update
                    if (data.data.metrics) {
                        updateMetrics(data.data.metrics);
                    }
                    if (data.data.system_info) {
                        updateSystemStatus(data.data.system_info);
                    }
                    // Update charts if included
                    if (data.data.metrics || data.data.system_info) {
                        updateChartsWithData(data.data);
                    }
                    break;
                case 'sell_all_list_update':
                    updateSellAllList(data.data);
                    break;
                case 'audit_update':
                    // Optionally refresh audit trail on new events
                    if (currentPage === 1) {
                        loadAuditTrail();
                    }
                    break;
                case 'metrics_reset':
                    // Handle metrics reset
                    updateMetrics(data.data);
                    showAlert('Métricas foram resetadas com sucesso', 'info');
                    break;
                default:
                    console.log('Unknown WebSocket message type:', data.type);
            }
        }
        
        // Update connection status indicator
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            const statusAlert = document.getElementById('connectionStatus');
            
            if (connected) {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'Conectado';
                statusAlert.style.display = 'none';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'Desconectado';
                statusAlert.style.display = 'block';
            }
        }
        
        // Initialize charts
        function initializeCharts() {
            // Signals per hour chart
            const signalsCtx = document.getElementById('signalsChart').getContext('2d');
            signalsChart = new Chart(signalsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sinais Recebidos',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Approval rate chart
            const approvalCtx = document.getElementById('approvalChart').getContext('2d');
            approvalChart = new Chart(approvalCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Aprovados', 'Rejeitados'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Load initial data
        async function loadInitialData() {
            try {
                // Load status data
                await loadSystemStatus();
                
                // Load sell all list
                await loadSellAllList();
                
                // Load top-N tickers list
                await loadTopNTickers();
                
                // Load audit trail
                await loadAuditTrail();
                
            } catch (error) {
                console.error('Error loading initial data:', error);
                showAlert('Erro ao carregar dados iniciais', 'danger');
            }
        }
        
        // Load system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/admin/system-info');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                updateMetrics(data.metrics);
                updateSystemStatus(data.system_info);
                updateChartsWithData(data);
                
            } catch (error) {
                console.error('Error loading system status:', error);
                showAlert('Erro ao carregar status do sistema: ' + error.message, 'warning');
            }
        }
        
        // Update metrics display
        function updateMetrics(metrics) {
            if (!metrics) return;
            
            document.getElementById('signalsReceived').textContent = metrics.signals_received || 0;
            document.getElementById('signalsApproved').textContent = metrics.signals_approved || 0;
            document.getElementById('signalsRejected').textContent = metrics.signals_rejected || 0;
            document.getElementById('signalsForwarded').textContent = metrics.signals_forwarded_success || 0;
            document.getElementById('processingQueueSize').textContent = metrics.processing_queue_size || 0;
            document.getElementById('approvedQueueSize').textContent = metrics.approved_queue_size || 0;
            document.getElementById('forwardingWorkersActive').textContent = metrics.forwarding_workers_active || 0;
            
            // Update worker progress bar
            const maxWorkers = 10; // Assuming max 10 workers
            const activeWorkers = metrics.forwarding_workers_active || 0;
            const progressPercent = (activeWorkers / maxWorkers) * 100;
            document.getElementById('workerProgress').style.width = `${progressPercent}%`;
              // Update approval chart with real data
            if (approvalChart) {
                const approved = metrics.signals_approved || 0;
                const rejected = metrics.signals_rejected || 0;
                const total = approved + rejected;
                
                approvalChart.data.datasets[0].data = [approved, rejected];
                approvalChart.update();
                
                // Add data source note
                const approvalContainer = document.querySelector('#approvalChart').parentElement;
                let approvalNote = approvalContainer.querySelector('.approval-data-note');
                if (!approvalNote) {
                    approvalNote = document.createElement('small');
                    approvalNote.className = 'approval-data-note text-muted d-block mt-2';
                    approvalContainer.appendChild(approvalNote);
                }
                
                if (total > 0) {
                    const approvalRate = ((approved / total) * 100).toFixed(1);
                    approvalNote.textContent = `📊 Taxa de aprovação: ${approvalRate}% (${approved}/${total})`;
                    approvalNote.className = 'approval-data-note text-success d-block mt-2';
                } else {
                    approvalNote.textContent = '📊 Aguardando dados de sinais...';
                    approvalNote.className = 'approval-data-note text-muted d-block mt-2';
                }
            }
        }
        
        // Update system status
        function updateSystemStatus(systemInfo) {
            if (!systemInfo) return;
            
            // Engine status
            const engineStatus = document.getElementById('engineStatus');
            const enginePaused = systemInfo.finviz_engine_paused || false;
            if (enginePaused) {
                engineStatus.textContent = 'Pausado';
                engineStatus.className = 'badge badge-status bg-warning';
            } else {
                engineStatus.textContent = 'Ativo';
                engineStatus.className = 'badge badge-status bg-success';
            }
            
            // Rate limiter status
            const rateLimiterStatus = document.getElementById('rateLimiterStatus');
            const rlPaused = systemInfo.webhook_rate_limiter_paused || false;
            if (rlPaused) {
                rateLimiterStatus.textContent = 'Pausado';
                rateLimiterStatus.className = 'badge badge-status bg-warning';
            } else {
                rateLimiterStatus.textContent = 'Ativo';
                rateLimiterStatus.className = 'badge badge-status bg-success';
            }
            
            // Ticker count
            const tickerCount = systemInfo.finviz_ticker_count || 0;
            document.getElementById('tickerCount').textContent = tickerCount;
            
            // Uptime
            if (systemInfo.uptime_seconds) {
                const uptime = formatUptime(systemInfo.uptime_seconds);
                document.getElementById('uptime').textContent = uptime;
            }
        }        // Update charts with historical data
        async function updateChartsWithData(data) {
            // Always try to get real historical data from the database
            try {
                console.log('Fetching signals history...');
                const historyResponse = await fetch('/admin/signals-history?hours=24');
                if (!historyResponse.ok) {
                    throw new Error(`HTTP ${historyResponse.status}: ${historyResponse.statusText}`);
                }
                const historyData = await historyResponse.json();
                console.log('History data received:', historyData);
                
                // Always update chart, even with zero data
                if (historyData.data && Array.isArray(historyData.data)) {
                    const labels = historyData.data.map(item => item.hour || item.hour_label || 'N/A');
                    const signalData = historyData.data.map(item => 
                        item.signals_received || item.total_signals || 0
                    );
                    
                    console.log('Chart data - Labels:', labels, 'Data:', signalData);
                    
                    if (signalsChart) {
                        signalsChart.data.labels = labels;
                        signalsChart.data.datasets[0].data = signalData;
                        signalsChart.update();
                        console.log('Chart updated successfully');
                    }
                    
                    // Update data source note
                    updateChartSourceNote(historyData);
                    return; // Success - exit early
                } else {
                    console.warn('No data array in history response');
                    throw new Error('Invalid data format received');
                }
            } catch (error) {
                console.error('Failed to load historical data:', error);
                showAlert('Dados históricos não disponíveis, usando fallback', 'warning');
                
                // Generate fallback data if all else fails
                generateFallbackChartData(data);
            }
        }
        
        function updateChartSourceNote(historyData) {
            const chartContainer = document.querySelector('#signalsChart').parentElement;
            let sourceNote = chartContainer.querySelector('.data-source-note');
            if (!sourceNote) {
                sourceNote = document.createElement('small');
                sourceNote.className = 'data-source-note text-muted d-block mt-2';
                chartContainer.appendChild(sourceNote);
            }
            
            const totalSignals = historyData.data ? 
                historyData.data.reduce((sum, item) => sum + (item.signals_received || item.total_signals || 0), 0) : 0;
            
            if (historyData.source === 'database') {
                sourceNote.textContent = `📊 Dados reais do PostgreSQL (${totalSignals} sinais em 24h)`;
                sourceNote.className = 'data-source-note text-success d-block mt-2';
            } else if (historyData.source === 'calculated') {
                sourceNote.textContent = `📈 Dados estimados (${totalSignals} sinais estimados)`;
                sourceNote.className = 'data-source-note text-warning d-block mt-2';
            } else {
                sourceNote.textContent = `ℹ️ Fonte: ${historyData.source || 'desconhecida'} (${totalSignals} sinais)`;
                sourceNote.className = 'data-source-note text-info d-block mt-2';
            }
        }
        
        function generateFallbackChartData(data) {
            if (!signalsChart) return;
            
            // Generate hourly labels for the last 24 hours
            const now = new Date();
            const labels = [];
            const signalData = [];
            
            // Get current metrics for reference
            const totalSignals = data?.metrics?.signals_received || 0;
            const hoursOfUptime = data?.system_info?.uptime_seconds ? 
                Math.min(24, data.system_info.uptime_seconds / 3600) : 1;
            
            // Generate basic fallback data
            for (let i = 23; i >= 0; i--) {
                const hour = new Date(now.getTime() - (i * 60 * 60 * 1000));
                labels.push(hour.getHours().toString().padStart(2, '0') + ':00');
                
                if (i >= (24 - hoursOfUptime)) {
                    // System was running during this hour
                    const hourlyAverage = hoursOfUptime > 0 ? totalSignals / hoursOfUptime : 0;
                    signalData.push(Math.max(0, Math.floor(hourlyAverage + (Math.random() - 0.5) * hourlyAverage * 0.3)));
                } else {
                    // System wasn't running - no signals
                    signalData.push(0);
                }
            }
            
            signalsChart.data.labels = labels;
            signalsChart.data.datasets[0].data = signalData;
            signalsChart.update();
            
            // Add fallback note
            const chartContainer = document.querySelector('#signalsChart').parentElement;
            let sourceNote = chartContainer.querySelector('.data-source-note');
            if (!sourceNote) {
                sourceNote = document.createElement('small');
                sourceNote.className = 'data-source-note text-muted d-block mt-2';
                chartContainer.appendChild(sourceNote);
            }
            sourceNote.textContent = '⚠️ Dados básicos de fallback (histórico indisponível)';
            sourceNote.className = 'data-source-note text-muted d-block mt-2';
        }
        
        // Load sell all list
        async function loadSellAllList() {
            try {
                const response = await fetch('/admin/sell-all-queue');
                const data = await response.json();
                updateSellAllList(data);
            } catch (error) {
                console.error('Error loading sell all list:', error);
            }
        }
        
        // Update sell all list display
        function updateSellAllList(data) {
            const container = document.getElementById('sellAllTickers');
            
            if (!data || !data.tickers || data.tickers.length === 0) {
                container.innerHTML = '<span class="text-muted">Nenhum ticker na lista</span>';
                return;
            }
            
            const tickersHtml = data.tickers.map(ticker => 
                `<span class="sell-all-ticker">${ticker}</span>`
            ).join('');
            
            container.innerHTML = tickersHtml;
        }
        
        // Load top-N tickers list
        async function loadTopNTickers() {
            try {
                const response = await fetch('/admin/top-n-tickers');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                updateTopNTickers(data);
                
            } catch (error) {
                console.error('Error loading top-N tickers:', error);
                showAlert('Erro ao carregar lista de Top-N Tickers: ' + error.message, 'danger');
            }
        }
        
        // Update top-N tickers display
        function updateTopNTickers(data) {
            const container = document.getElementById('topNTickers');
            const countDisplay = document.getElementById('topNTickerCount');
            const timestampDisplay = document.getElementById('topNTimestamp');
            
            if (!data || !data.tickers || data.tickers.length === 0) {
                container.innerHTML = '<span class="text-muted">Nenhum ticker aprovado</span>';
                countDisplay.textContent = '0';
                timestampDisplay.textContent = '-';
                return;
            }
            
            const tickersHtml = data.tickers.map(ticker => 
                `<span class="sell-all-ticker">${ticker}</span>`
            ).join('');
            
            container.innerHTML = tickersHtml;
            countDisplay.textContent = data.tickers.length;
            
            // Update timestamp - try multiple possible timestamp fields
            const timestampFields = ['last_update', 'timestamp', 'engine_info.last_update'];
            let timestampValue = null;
            
            for (const field of timestampFields) {
                if (field.includes('.')) {
                    // Handle nested properties like engine_info.last_update
                    const parts = field.split('.');
                    let value = data;
                    for (const part of parts) {
                        if (value && value[part] !== undefined) {
                            value = value[part];
                        } else {
                            value = null;
                            break;
                        }
                    }
                    if (value) {
                        timestampValue = value;
                        break;
                    }
                } else {
                    if (data[field]) {
                        timestampValue = data[field];
                        break;
                    }
                }
            }
            
            if (timestampValue) {
                try {
                    // Handle both Unix timestamp (seconds) and ISO strings
                    let date;
                    if (typeof timestampValue === 'number') {
                        // Unix timestamp - might be in seconds or milliseconds
                        date = timestampValue > 1000000000000 ? 
                               new Date(timestampValue) : 
                               new Date(timestampValue * 1000);
                    } else {
                        date = new Date(timestampValue);
                    }
                    
                    if (!isNaN(date.getTime())) {
                        const options = { 
                            year: 'numeric', month: 'numeric', day: 'numeric', 
                            hour: 'numeric', minute: 'numeric', second: 'numeric', 
                            hour12: false 
                        };
                        timestampDisplay.textContent = date.toLocaleString('pt-BR', options);
                    } else {
                        timestampDisplay.textContent = 'Data inválida';
                    }
                } catch (e) {
                    console.warn('Error parsing timestamp:', timestampValue, e);
                    timestampDisplay.textContent = 'Erro na data';
                }
            } else {
                timestampDisplay.textContent = 'Agora';
            }
        }
        
        // Load audit trail
        async function loadAuditTrail() {
            if (isLoading) return;
            
            isLoading = true;
            const tbody = document.getElementById('auditTableBody');
            const spinner = tbody.querySelector('.loading-spinner');
            
            if (spinner) {
                spinner.style.display = 'inline-block';
            }
            
            try {
                const params = new URLSearchParams();
                
                // Get filter values
                const limit = document.getElementById('limitSelect').value;
                const status = document.getElementById('statusFilter').value;
                const ticker = document.getElementById('tickerFilter').value;
                const signalId = document.getElementById('signalIdFilter').value;
                const hours = document.getElementById('hourFilter').value;
                
                params.append('limit', limit);
                params.append('offset', (currentPage - 1) * parseInt(limit));
                
                if (status) params.append('status_filter', status);
                if (ticker) params.append('ticker', ticker);
                if (signalId) params.append('signal_id', signalId);
                if (hours) params.append('hours', hours);
                
                const response = await fetch(`/admin/audit-trail?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                displayAuditTrail(data);
                updatePagination(data);
                
            } catch (error) {
                console.error('Error loading audit trail:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados da auditoria: ' + error.message + '</td></tr>';
                showAlert('Erro ao carregar auditoria: ' + error.message, 'danger');
            } finally {
                isLoading = false;
            }
        }
        
        // Display audit trail data
        function displayAuditTrail(data) {
            const tbody = document.getElementById('auditTableBody');
            
            if (!data.events || data.events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum evento encontrado</td></tr>';
                return;
            }
            
            const rows = data.events.map(event => {
                // Handle invalid timestamps more robustly
                let timestamp = 'Data inválida';
                if (event.timestamp) {
                    try {
                        let date;
                        // Handle different timestamp formats
                        if (typeof event.timestamp === 'number') {
                            // Unix timestamp - check if it's in seconds or milliseconds
                            date = event.timestamp > 1000000000000 ? 
                                   new Date(event.timestamp) : 
                                   new Date(event.timestamp * 1000);
                        } else if (typeof event.timestamp === 'string') {
                            // ISO string or other string format
                            // Check if it's ISO format with Z suffix
                            if (event.timestamp.includes('T')) {
                                date = new Date(event.timestamp);
                            } else {
                                // Try parsing as Unix timestamp string
                                const numTimestamp = parseFloat(event.timestamp);
                                if (!isNaN(numTimestamp)) {
                                    date = numTimestamp > 1000000000000 ? 
                                           new Date(numTimestamp) : 
                                           new Date(numTimestamp * 1000);
                                } else {
                                    date = new Date(event.timestamp);
                                }
                            }
                        } else {
                            date = new Date(event.timestamp);
                        }
                        
                        if (date && !isNaN(date.getTime())) {
                            timestamp = date.toLocaleString('pt-BR', {
                                year: 'numeric', month: '2-digit', day: '2-digit',
                                hour: '2-digit', minute: '2-digit', second: '2-digit',
                                hour12: false
                            });
                        }
                    } catch (e) {
                        console.warn('Invalid timestamp format:', event.timestamp, e);
                        // Try to show the raw timestamp if parsing fails
                        timestamp = String(event.timestamp);
                    }
                }
                
                const statusBadge = getStatusBadge(event.event_type);
                const locationBadge = getLocationBadge(event.location);
                const httpStatus = event.http_status || (event.http_status === 0 ? '0' : '-');
                const details = event.details || '-';
                const workerId = event.worker_id || '-';
                const signalId = event.signal_id ? 
                    event.signal_id : 
                    'N/A';
                
                return `
                    <tr>
                        <td>${timestamp}</td>
                        <td><code>${signalId}</code></td>
                        <td><strong>${event.ticker || '-'}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${locationBadge}</td>
                        <td><small>${workerId}</small></td>
                        <td><small>${details}</small></td>
                        <td>${httpStatus}</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }
        
        // Get status badge HTML
        function getStatusBadge(status) {
            const statusColors = {
                'RECEIVED': 'bg-info',
                'APPROVED': 'bg-success',
                'REJECTED': 'bg-warning',
                'FORWARDED_SUCCESS': 'bg-success',
                'FORWARDED_HTTP_ERROR': 'bg-danger',
                'FORWARDED_GENERIC_ERROR': 'bg-danger',
                'ERROR': 'bg-danger',
                'PROCESSING': 'bg-primary',
                'FORWARDING': 'bg-info'
            };
            
            const color = statusColors[status] || 'bg-secondary';
            return `<span class="badge ${color}">${status}</span>`;
        }
        
        // Get location badge HTML
        function getLocationBadge(location) {
            const locationColors = {
                'PROCESSING_QUEUE': 'bg-primary',
                'APPROVED_QUEUE': 'bg-warning',
                'WORKER_PROCESSING': 'bg-info',
                'WORKER_FORWARDING': 'bg-info',
                'COMPLETED': 'bg-success',
                'DISCARDED': 'bg-secondary'
            };
            
            const color = locationColors[location] || 'bg-secondary';
            return `<span class="badge ${color}">${location}</span>`;
        }
        
        // Update pagination controls
        function updatePagination(data) {
            const resultsInfo = document.getElementById('auditResultsInfo');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            const limit = parseInt(document.getElementById('limitSelect').value);
            const total = data.total || 0;
            const hasMore = data.has_more || false;
            
            resultsInfo.textContent = `Exibindo ${data.events?.length || 0} de ${total} eventos`;
            pageInfo.textContent = `Página ${currentPage}`;
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = !hasMore;
        }
        
        // Bind event handlers
        function bindEventHandlers() {
            // Control buttons
            document.getElementById('pauseEngineBtn').addEventListener('click', () => sendControlCommand('/admin/engine/pause', 'Engine pausado'));
            document.getElementById('resumeEngineBtn').addEventListener('click', () => sendControlCommand('/admin/engine/resume', 'Engine retomado'));
            document.getElementById('refreshEngineBtn').addEventListener('click', () => sendControlCommand('/admin/engine/manual-refresh', 'Atualização de tickers iniciada'));
            document.getElementById('resetMetricsBtn').addEventListener('click', () => sendControlCommand('/admin/metrics/reset', 'Métricas resetadas'));
            document.getElementById('pauseRateLimiterBtn').addEventListener('click', () => sendControlCommand('/admin/webhook-rate-limiter/pause', 'Rate Limiter pausado'));
            document.getElementById('resumeRateLimiterBtn').addEventListener('click', () => sendControlCommand('/admin/webhook-rate-limiter/resume', 'Rate Limiter retomado'));
            
            // Sell all buttons
            document.getElementById('executeSellAllBtn').addEventListener('click', executeSellAll);
            document.getElementById('refreshSellAllBtn').addEventListener('click', loadSellAllList);
            
            // Top-N refresh button
            document.getElementById('refreshTopNBtn').addEventListener('click', loadTopNTickers);
            
            // Audit trail controls
            document.getElementById('applyFiltersBtn').addEventListener('click', () => {
                currentPage = 1;
                loadAuditTrail();
            });
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadAuditTrail();
                }
            });
            document.getElementById('nextPageBtn').addEventListener('click', () => {
                currentPage++;
                loadAuditTrail();
            });
        }
        
        // Send control command
        async function sendControlCommand(endpoint, successMessage) {
            try {
                // Get admin token if needed
                let token = localStorage.getItem('admin_token');
                if (!token) {
                    token = prompt('Digite o token de administrador:');
                    if (!token) {
                        showAlert('Token necessário para executar comandos administrativos', 'warning');
                        return;
                    }
                    localStorage.setItem('admin_token', token);
                }

                const response = await fetch(endpoint, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token: token })
                });
                
                if (response.ok) {
                    showAlert(successMessage, 'success');
                    // Refresh status after a short delay
                    setTimeout(loadSystemStatus, 1000);
                } else if (response.status === 403) {
                    // Clear invalid token
                    localStorage.removeItem('admin_token');
                    showAlert('Token inválido. Tente novamente.', 'danger');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error(`Error sending command to ${endpoint}:`, error);
                showAlert(`Erro ao executar comando: ${error.message}`, 'danger');
            }
        }
        
        // Execute sell all
        async function executeSellAll() {
            if (!confirm('Tem certeza que deseja executar SELL ALL? Esta ação irá vender todas as posições na lista.')) {
                return;
            }
            
            try {
                // Get admin token
                let token = localStorage.getItem('admin_token');
                if (!token) {
                    token = prompt('Digite o token de administrador:');
                    if (!token) {
                        showAlert('Token necessário para executar SELL ALL', 'warning');
                        return;
                    }
                    localStorage.setItem('admin_token', token);
                }

                const response = await fetch('/admin/order/sell-all', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showAlert(`Sell All executado com sucesso! ${data.signals_sent || data.processed_tickers || 'N/A'} sinais enviados.`, 'success');
                    loadSellAllList();
                } else if (response.status === 403) {
                    localStorage.removeItem('admin_token');
                    showAlert('Token inválido. Tente novamente.', 'danger');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error executing sell all:', error);
                showAlert(`Erro ao executar Sell All: ${error.message}`, 'danger');
            }
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('tickerFilter').value = '';
            document.getElementById('signalIdFilter').value = '';
            document.getElementById('hourFilter').value = '';
            currentPage = 1;
            loadAuditTrail();
        }
        
        // Show alert
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
        
        // Format uptime
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) {
                return `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
        
        // Configuration Panel Functions
        function initializeConfigPanel() {
            // Bind configuration modal events
            document.getElementById('openConfigBtn').addEventListener('click', openConfigModal);
            document.getElementById('setTokenBtn').addEventListener('click', setAdminToken);
            document.getElementById('loadCurrentConfigBtn').addEventListener('click', loadCurrentConfig);
            
            // Bind configuration update buttons
            document.getElementById('updateWebhookBtn').addEventListener('click', updateWebhookConfig);
            document.getElementById('updateFinvizBtn').addEventListener('click', updateFinvizConfig);
            document.getElementById('updateRateLimiterBtn').addEventListener('click', updateRateLimiterConfig);
            
            // Token management
            document.getElementById('saveTokenBtn').addEventListener('click', saveAdminToken);
            document.getElementById('clearTokenBtn').addEventListener('click', clearAdminToken);
            document.getElementById('toggleTokenVisibility').addEventListener('click', toggleTokenVisibility);
            
            // Load saved token if available
            loadSavedToken();
        }
        
        function openConfigModal() {
            const modal = new bootstrap.Modal(document.getElementById('configModal'));
            modal.show();
            loadCurrentConfig();
        }
        
        function setAdminToken() {
            const token = prompt('Digite o token de administrador:');
            if (token) {
                localStorage.setItem('admin_token', token);
                document.getElementById('adminToken').value = token;
                showAlert('Token salvo com sucesso!', 'success');
            }
        }
        
        async function loadCurrentConfig() {
            try {
                // Load webhook config
                const webhookResponse = await fetch('/admin/webhook/config');
                if (webhookResponse.ok) {
                    const webhookData = await webhookResponse.json();
                    document.getElementById('webhookUrl').value = webhookData.webhook_url || '';
                    document.getElementById('webhookTimeout').value = webhookData.timeout || 5;
                }
                
                // Load finviz config
                const finvizResponse = await fetch('/admin/finviz/config');
                if (finvizResponse.ok) {
                    const finvizData = await finvizResponse.json();
                    document.getElementById('finvizUrl').value = finvizData.finviz_url || '';
                    document.getElementById('topN').value = finvizData.top_n || 15;
                    document.getElementById('refreshInterval').value = finvizData.refresh_interval_sec || 10;
                }
                
                // Load rate limiter config (from system status)
                const statusResponse = await fetch('/admin/system-info');
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    const rlInfo = statusData.system_info?.webhook_rate_limiter || {};
                    document.getElementById('maxReqPerMin').value = rlInfo.max_req_per_min || 60;
                    document.getElementById('rateLimitingEnabled').checked = !rlInfo.paused;
                }
                
            } catch (error) {
                console.error('Error loading current config:', error);
                showAlert('Erro ao carregar configurações atuais', 'warning');
            }
        }
        
        async function updateWebhookConfig() {
            const token = getAdminToken();
            if (!token) return;
            
            const webhookUrl = document.getElementById('webhookUrl').value;
            const timeout = document.getElementById('webhookTimeout').value;
            
            if (!webhookUrl) {
                showAlert('URL do webhook é obrigatória', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/admin/webhook/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        webhook_url: webhookUrl,
                        timeout: parseInt(timeout)
                    })
                });
                
                if (response.ok) {
                    showAlert('Configuração do webhook atualizada com sucesso!', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error updating webhook config:', error);
                showAlert('Erro ao atualizar configuração do webhook: ' + error.message, 'danger');
            }
        }
        
        async function updateFinvizConfig() {
            const token = getAdminToken();
            if (!token) return;
            
            const finvizUrl = document.getElementById('finvizUrl').value;
            const topN = document.getElementById('topN').value;
            const refreshInterval = document.getElementById('refreshInterval').value;
            
            if (!finvizUrl) {
                showAlert('URL do Finviz é obrigatória', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/finviz/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        finviz_url: finvizUrl,
                        top_n: parseInt(topN),
                        refresh_interval_sec: parseInt(refreshInterval)
                    })
                });
                
                if (response.ok) {
                    showAlert('Configuração do Finviz atualizada com sucesso!', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error updating finviz config:', error);
                showAlert('Erro ao atualizar configuração do Finviz: ' + error.message, 'danger');
            }
        }
        
        async function updateRateLimiterConfig() {
            const token = getAdminToken();
            if (!token) return;
            
            const maxReqPerMin = document.getElementById('maxReqPerMin').value;
            const enabled = document.getElementById('rateLimitingEnabled').checked;
            
            try {
                const response = await fetch('/admin/webhook-rate-limiter/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        max_req_per_min: parseInt(maxReqPerMin),
                        enabled: enabled
                    })
                });
                
                if (response.ok) {
                    showAlert('Configuração do Rate Limiter atualizada com sucesso!', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error updating rate limiter config:', error);
                showAlert('Erro ao atualizar configuração do Rate Limiter: ' + error.message, 'danger');
            }
        }
        
        function getAdminToken() {
            let token = localStorage.getItem('admin_token');
            if (!token) {
                token = prompt('Digite o token de administrador:');
                if (token) {
                    localStorage.setItem('admin_token', token);
                } else {
                    showAlert('Token necessário para realizar alterações', 'warning');
                    return null;
                }
            }
            return token;
        }
        
        function saveAdminToken() {
            const token = document.getElementById('adminToken').value;
            if (token) {
                localStorage.setItem('admin_token', token);
                showAlert('Token salvo com sucesso!', 'success');
            } else {
                showAlert('Digite um token válido', 'warning');
            }
        }
        
        function clearAdminToken() {
            localStorage.removeItem('admin_token');
            document.getElementById('adminToken').value = '';
            showAlert('Token removido', 'info');
        }
        
        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('adminToken');
            const toggleBtn = document.getElementById('toggleTokenVisibility');
            const icon = toggleBtn.querySelector('i');
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                icon.className = 'bi bi-eye-slash';
            } else {
                tokenInput.type = 'password';
                icon.className = 'bi bi-eye';
            }
        }
        
        function loadSavedToken() {
            const savedToken = localStorage.getItem('admin_token');
            if (savedToken) {
                document.getElementById('adminToken').value = savedToken;
            }
        }
        
        // Initialize configuration panel when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeConfigPanel();
        });
    </script>
</body>
</html>
