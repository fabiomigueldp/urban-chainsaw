<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Signal Processor - Admin Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bs-primary: #0d6efd;
            --bs-success: #198754;
            --bs-warning: #ffc107;
            --bs-danger: #dc3545;
            --bs-info: #0dcaf0;
            --bs-dark: #212529;
            --bs-light: #f8f9fa;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .status-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: var(--bs-success);
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background-color: var(--bs-danger);
        }
        
        .status-paused {
            background-color: var(--bs-warning);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .audit-table {
            font-size: 0.875rem;
        }
        
        .badge-status {
            font-size: 0.75rem;
        }
        
        .refresh-btn {
            transition: transform 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: rotate(180deg);
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 200px;
        }
        
        .filter-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 20px;
        }
        
        .section-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .action-buttons .btn {
            margin: 0 5px 10px 0;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .table-responsive {
            max-height: 500px;
        }
        
        .progress-container {
            margin: 10px 0;
        }
        
        .alert-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1040;
            max-width: 400px;
        }
        
        .sell-all-ticker {
            margin: 2px;
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 0.875rem;
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- Connection Status Alert -->
    <div id="connectionStatus" class="connection-status">
        <div class="alert alert-info alert-dismissible" role="alert">
            <i class="bi bi-wifi"></i> Conectando ao servidor...
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
    
    <!-- Alert Container -->
    <div id="alertContainer" class="alert-container"></div>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up-arrow"></i>
                Trading Signal Processor
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span id="connectionIndicator" class="status-indicator status-offline"></span>
                    <span id="connectionText">Desconectado</span>
                </span>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-primary" id="signalsReceived">-</div>
                        <div class="metric-label">Sinais Recebidos</div>
                        <small class="text-muted">Total desde início</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-success" id="signalsApproved">-</div>
                        <div class="metric-label">Sinais Aprovados</div>
                        <small class="text-muted">Passou no filtro Top-N</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-warning" id="signalsRejected">-</div>
                        <div class="metric-label">Sinais Rejeitados</div>
                        <small class="text-muted">Não passou no filtro</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-info" id="signalsForwarded">-</div>
                        <div class="metric-label">Sinais Encaminhados</div>
                        <small class="text-muted">Enviados com sucesso</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Queue Status and System Info -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-queue"></i> Status das Filas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="metric-value text-primary" id="processingQueueSize">-</div>
                                <div class="metric-label">Fila de Processamento</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value text-warning" id="approvedQueueSize">-</div>
                                <div class="metric-label">Fila de Encaminhamento</div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="d-flex justify-content-between small">
                                <span>Workers Ativos:</span>
                                <span id="forwardingWorkersActive">-</span>
                            </div>
                            <div class="progress">
                                <div id="workerProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle"></i> Sistema
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <strong>Engine Status:</strong><br>
                                <span id="engineStatus" class="badge badge-status">-</span>
                            </div>
                            <div class="col-6">
                                <strong>Rate Limiter:</strong><br>
                                <span id="rateLimiterStatus" class="badge badge-status">-</span>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>Tickers Top-N:</strong><br>
                                <span id="tickerCount">-</span>
                            </div>
                            <div class="col-6">
                                <strong>Uptime:</strong><br>
                                <span id="uptime">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-bar-chart"></i> Sinais por Hora
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="signalsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-pie-chart"></i> Taxa de Aprovação
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="approvalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Control Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-gear"></i> Controles do Sistema
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="action-buttons">
                            <button id="pauseEngineBtn" class="btn btn-warning">
                                <i class="bi bi-pause"></i> Pausar Engine
                            </button>
                            <button id="resumeEngineBtn" class="btn btn-success">
                                <i class="bi bi-play"></i> Retomar Engine
                            </button>
                            <button id="refreshEngineBtn" class="btn btn-info">
                                <i class="bi bi-arrow-clockwise refresh-btn"></i> Atualizar Tickers
                            </button>
                            <button id="resetMetricsBtn" class="btn btn-secondary">
                                <i class="bi bi-arrow-counterclockwise"></i> Resetar Métricas
                            </button>
                            <button id="pauseRateLimiterBtn" class="btn btn-warning">
                                <i class="bi bi-pause"></i> Pausar Rate Limiter
                            </button>
                            <button id="resumeRateLimiterBtn" class="btn btn-success">
                                <i class="bi bi-play"></i> Retomar Rate Limiter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sell All Management -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-check"></i> Gerenciamento Sell All
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Tickers na Lista Sell All:</h6>
                                <div id="sellAllTickers" class="mb-3">
                                    <span class="text-muted">Carregando...</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid gap-2">
                                    <button id="executeSellAllBtn" class="btn btn-danger">
                                        <i class="bi bi-exclamation-triangle"></i> Executar Sell All
                                    </button>
                                    <button id="refreshSellAllBtn" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-clockwise"></i> Atualizar Lista
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Audit Trail -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-journal-text"></i> Trilha de Auditoria
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="filter-card p-3 mb-3">
                            <div class="row">
                                <div class="col-md-2">
                                    <label for="limitSelect" class="form-label">Limite:</label>
                                    <select id="limitSelect" class="form-select form-select-sm">
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="1000">1000</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="statusFilter" class="form-label">Status:</label>
                                    <select id="statusFilter" class="form-select form-select-sm">
                                        <option value="">Todos</option>
                                        <option value="RECEIVED">Recebido</option>
                                        <option value="APPROVED">Aprovado</option>
                                        <option value="REJECTED">Rejeitado</option>
                                        <option value="FORWARDED_SUCCESS">Encaminhado</option>
                                        <option value="FORWARDED_HTTP_ERROR">Erro HTTP</option>
                                        <option value="ERROR">Erro</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="tickerFilter" class="form-label">Ticker:</label>
                                    <input type="text" id="tickerFilter" class="form-control form-control-sm" placeholder="Ex: AAPL">
                                </div>
                                <div class="col-md-2">
                                    <label for="hourFilter" class="form-label">Últimas horas:</label>
                                    <select id="hourFilter" class="form-select form-select-sm">
                                        <option value="">Todas</option>
                                        <option value="1">1 hora</option>
                                        <option value="6">6 horas</option>
                                        <option value="24">24 horas</option>
                                        <option value="168">7 dias</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button id="applyFiltersBtn" class="btn btn-primary btn-sm">
                                            <i class="bi bi-funnel"></i> Filtrar
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button id="clearFiltersBtn" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-x-circle"></i> Limpar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audit Table -->
                        <div class="table-responsive">
                            <table class="table table-hover table-sm audit-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Signal ID</th>
                                        <th>Ticker</th>
                                        <th>Status</th>
                                        <th>Localização</th>
                                        <th>Worker</th>
                                        <th>Detalhes</th>
                                        <th>HTTP</th>
                                    </tr>
                                </thead>
                                <tbody id="auditTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="loading-spinner spinner-border" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            Carregando dados da auditoria...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="text-muted">
                                <span id="auditResultsInfo">-</span>
                            </div>
                            <div>
                                <button id="prevPageBtn" class="btn btn-outline-secondary btn-sm me-2" disabled>
                                    <i class="bi bi-chevron-left"></i> Anterior
                                </button>
                                <span id="pageInfo" class="mx-2">Página 1</span>
                                <button id="nextPageBtn" class="btn btn-outline-secondary btn-sm ms-2" disabled>
                                    Próxima <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let socket = null;
        let signalsChart = null;
        let approvalChart = null;
        let currentPage = 1;
        let isLoading = false;
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            initializeCharts();
            loadInitialData();
            bindEventHandlers();
            
            // Auto-refresh audit trail every 30 seconds
            setInterval(loadAuditTrail, 30000);
        });
          // WebSocket connection
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/admin-updates`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function(event) {
                updateConnectionStatus(true);
                console.log('WebSocket connected');
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            socket.onclose = function(event) {
                updateConnectionStatus(false);
                console.log('WebSocket disconnected, attempting to reconnect...');
                // Attempt to reconnect every 5 seconds
                setTimeout(initializeWebSocket, 5000);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }
          // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'metrics_update':
                    updateMetrics(data.data);
                    break;
                case 'status_update':
                    // Handle comprehensive status update
                    if (data.data.metrics) {
                        updateMetrics(data.data.metrics);
                    }
                    if (data.data.system_info) {
                        updateSystemStatus(data.data.system_info);
                    }
                    // Update charts if included
                    if (data.data.metrics || data.data.system_info) {
                        updateChartsWithData(data.data);
                    }
                    break;
                case 'sell_all_list_update':
                    updateSellAllList(data.data);
                    break;
                case 'audit_update':
                    // Optionally refresh audit trail on new events
                    if (currentPage === 1) {
                        loadAuditTrail();
                    }
                    break;
                case 'metrics_reset':
                    // Handle metrics reset
                    updateMetrics(data.data);
                    showAlert('Métricas foram resetadas com sucesso', 'info');
                    break;
                default:
                    console.log('Unknown WebSocket message type:', data.type);
            }
        }
        
        // Update connection status indicator
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            const statusAlert = document.getElementById('connectionStatus');
            
            if (connected) {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'Conectado';
                statusAlert.style.display = 'none';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'Desconectado';
                statusAlert.style.display = 'block';
            }
        }
        
        // Initialize charts
        function initializeCharts() {
            // Signals per hour chart
            const signalsCtx = document.getElementById('signalsChart').getContext('2d');
            signalsChart = new Chart(signalsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sinais Recebidos',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Approval rate chart
            const approvalCtx = document.getElementById('approvalChart').getContext('2d');
            approvalChart = new Chart(approvalCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Aprovados', 'Rejeitados'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Load initial data
        async function loadInitialData() {
            try {
                // Load status data
                await loadSystemStatus();
                
                // Load sell all list
                await loadSellAllList();
                
                // Load audit trail
                await loadAuditTrail();
                
            } catch (error) {
                console.error('Error loading initial data:', error);
                showAlert('Erro ao carregar dados iniciais', 'danger');
            }
        }
        
        // Load system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/admin/status');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                updateMetrics(data.metrics);
                updateSystemStatus(data.system_info);
                updateChartsWithData(data);
                
            } catch (error) {
                console.error('Error loading system status:', error);
                showAlert('Erro ao carregar status do sistema: ' + error.message, 'warning');
            }
        }
        
        // Update metrics display
        function updateMetrics(metrics) {
            if (!metrics) return;
            
            document.getElementById('signalsReceived').textContent = metrics.signals_received || 0;
            document.getElementById('signalsApproved').textContent = metrics.signals_approved || 0;
            document.getElementById('signalsRejected').textContent = metrics.signals_rejected || 0;
            document.getElementById('signalsForwarded').textContent = metrics.signals_forwarded_success || 0;
            document.getElementById('processingQueueSize').textContent = metrics.processing_queue_size || 0;
            document.getElementById('approvedQueueSize').textContent = metrics.approved_queue_size || 0;
            document.getElementById('forwardingWorkersActive').textContent = metrics.forwarding_workers_active || 0;
            
            // Update worker progress bar
            const maxWorkers = 10; // Assuming max 10 workers
            const activeWorkers = metrics.forwarding_workers_active || 0;
            const progressPercent = (activeWorkers / maxWorkers) * 100;
            document.getElementById('workerProgress').style.width = `${progressPercent}%`;
              // Update approval chart with real data
            if (approvalChart) {
                const approved = metrics.signals_approved || 0;
                const rejected = metrics.signals_rejected || 0;
                const total = approved + rejected;
                
                approvalChart.data.datasets[0].data = [approved, rejected];
                approvalChart.update();
                
                // Add data source note
                const approvalContainer = document.querySelector('#approvalChart').parentElement;
                let approvalNote = approvalContainer.querySelector('.approval-data-note');
                if (!approvalNote) {
                    approvalNote = document.createElement('small');
                    approvalNote.className = 'approval-data-note text-muted d-block mt-2';
                    approvalContainer.appendChild(approvalNote);
                }
                
                if (total > 0) {
                    const approvalRate = ((approved / total) * 100).toFixed(1);
                    approvalNote.textContent = `📊 Taxa de aprovação: ${approvalRate}% (${approved}/${total})`;
                    approvalNote.className = 'approval-data-note text-success d-block mt-2';
                } else {
                    approvalNote.textContent = '📊 Aguardando dados de sinais...';
                    approvalNote.className = 'approval-data-note text-muted d-block mt-2';
                }
            }
        }
        
        // Update system status
        function updateSystemStatus(systemInfo) {
            if (!systemInfo) return;
            
            // Engine status
            const engineStatus = document.getElementById('engineStatus');
            const enginePaused = systemInfo.finviz_engine_paused || false;
            if (enginePaused) {
                engineStatus.textContent = 'Pausado';
                engineStatus.className = 'badge badge-status bg-warning';
            } else {
                engineStatus.textContent = 'Ativo';
                engineStatus.className = 'badge badge-status bg-success';
            }
            
            // Rate limiter status
            const rateLimiterStatus = document.getElementById('rateLimiterStatus');
            const rlPaused = systemInfo.webhook_rate_limiter_paused || false;
            if (rlPaused) {
                rateLimiterStatus.textContent = 'Pausado';
                rateLimiterStatus.className = 'badge badge-status bg-warning';
            } else {
                rateLimiterStatus.textContent = 'Ativo';
                rateLimiterStatus.className = 'badge badge-status bg-success';
            }
            
            // Ticker count
            const tickerCount = systemInfo.finviz_ticker_count || 0;
            document.getElementById('tickerCount').textContent = tickerCount;
            
            // Uptime
            if (systemInfo.uptime_seconds) {
                const uptime = formatUptime(systemInfo.uptime_seconds);
                document.getElementById('uptime').textContent = uptime;
            }
        }        // Update charts with historical data
        async function updateChartsWithData(data) {
            // Try to get real historical data from the new endpoint
            try {
                const historyResponse = await fetch('/admin/signals-history?hours=24');
                if (!historyResponse.ok) {
                    throw new Error(`HTTP ${historyResponse.status}: ${historyResponse.statusText}`);
                }
                const historyData = await historyResponse.json();
                
                if (historyData.data && historyData.data.length > 0) {
                    // Use real historical data
                    const labels = historyData.data.map(item => item.hour);
                    const signalData = historyData.data.map(item => item.signals_received);
                    
                    if (signalsChart) {
                        signalsChart.data.labels = labels;
                        signalsChart.data.datasets[0].data = signalData;
                        signalsChart.update();
                    }
                    
                    // Add note about data source
                    const chartContainer = document.querySelector('#signalsChart').parentElement;
                    let sourceNote = chartContainer.querySelector('.data-source-note');
                    if (!sourceNote) {
                        sourceNote = document.createElement('small');
                        sourceNote.className = 'data-source-note text-muted d-block mt-2';
                        chartContainer.appendChild(sourceNote);
                    }
                    
                    if (historyData.source === 'database') {
                        sourceNote.textContent = '📊 Dados reais do PostgreSQL';
                        sourceNote.className = 'data-source-note text-success d-block mt-2';
                    } else if (historyData.source === 'calculated') {
                        sourceNote.textContent = '📈 Dados estimados baseados nas métricas atuais';
                        sourceNote.className = 'data-source-note text-warning d-block mt-2';
                    }
                    
                    return; // Success - exit early
                }
            } catch (error) {
                console.warn('Failed to load historical data:', error);
                showAlert('Aviso: Dados históricos indisponíveis - ' + error.message, 'warning');
            }
            
            // Fallback to basic calculation if endpoint fails
            if (signalsChart && data.metrics) {
                // Generate hourly labels for the last 24 hours
                const now = new Date();
                const labels = [];
                const signalData = [];
                
                // Get current metrics for reference
                const totalSignals = data.metrics.signals_received || 0;
                const hoursOfUptime = data.system_info && data.system_info.uptime_seconds ? 
                    Math.min(24, data.system_info.uptime_seconds / 3600) : 0;
                
                // Generate basic fallback data
                for (let i = 23; i >= 0; i--) {
                    const hour = new Date(now.getTime() - (i * 60 * 60 * 1000));
                    labels.push(hour.getHours() + ':00');
                    
                    if (i >= (24 - hoursOfUptime)) {
                        // System was running during this hour
                        const hourlyAverage = hoursOfUptime > 0 ? totalSignals / hoursOfUptime : 0;
                        signalData.push(Math.max(0, Math.floor(hourlyAverage + (Math.random() - 0.5) * hourlyAverage * 0.3)));
                    } else {
                        // System wasn't running - no signals
                        signalData.push(0);
                    }
                }
                
                signalsChart.data.labels = labels;
                signalsChart.data.datasets[0].data = signalData;
                signalsChart.update();
                
                // Add fallback note
                const chartContainer = document.querySelector('#signalsChart').parentElement;
                let sourceNote = chartContainer.querySelector('.data-source-note');
                if (!sourceNote) {
                    sourceNote = document.createElement('small');
                    sourceNote.className = 'data-source-note text-muted d-block mt-2';
                    chartContainer.appendChild(sourceNote);
                }
                sourceNote.textContent = '⚠️ Dados básicos de fallback (histórico indisponível)';
                sourceNote.className = 'data-source-note text-muted d-block mt-2';
            }
        }
        
        // Load sell all list
        async function loadSellAllList() {
            try {
                const response = await fetch('/admin/sell-all-queue');
                const data = await response.json();
                updateSellAllList(data);
            } catch (error) {
                console.error('Error loading sell all list:', error);
            }
        }
        
        // Update sell all list display
        function updateSellAllList(data) {
            const container = document.getElementById('sellAllTickers');
            
            if (!data || !data.tickers || data.tickers.length === 0) {
                container.innerHTML = '<span class="text-muted">Nenhum ticker na lista</span>';
                return;
            }
            
            const tickersHtml = data.tickers.map(ticker => 
                `<span class="sell-all-ticker">${ticker}</span>`
            ).join('');
            
            container.innerHTML = tickersHtml;
        }
        
        // Load audit trail
        async function loadAuditTrail() {
            if (isLoading) return;
            
            isLoading = true;
            const tbody = document.getElementById('auditTableBody');
            const spinner = tbody.querySelector('.loading-spinner');
            
            if (spinner) {
                spinner.style.display = 'inline-block';
            }
            
            try {
                const params = new URLSearchParams();
                
                // Get filter values
                const limit = document.getElementById('limitSelect').value;
                const status = document.getElementById('statusFilter').value;
                const ticker = document.getElementById('tickerFilter').value;
                const hours = document.getElementById('hourFilter').value;
                
                params.append('limit', limit);
                params.append('offset', (currentPage - 1) * parseInt(limit));
                
                if (status) params.append('status_filter', status);
                if (ticker) params.append('ticker', ticker);
                if (hours) params.append('hours', hours);
                
                const response = await fetch(`/admin/audit-trail?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                displayAuditTrail(data);
                updatePagination(data);
                
            } catch (error) {
                console.error('Error loading audit trail:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados da auditoria: ' + error.message + '</td></tr>';
                showAlert('Erro ao carregar auditoria: ' + error.message, 'danger');
            } finally {
                isLoading = false;
            }
        }
        
        // Display audit trail data
        function displayAuditTrail(data) {
            const tbody = document.getElementById('auditTableBody');
            
            if (!data.events || data.events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum evento encontrado</td></tr>';
                return;
            }
            
            const rows = data.events.map(event => {
                const timestamp = new Date(event.timestamp).toLocaleString('pt-BR');
                const statusBadge = getStatusBadge(event.event_type);
                const locationBadge = getLocationBadge(event.location);
                const httpStatus = event.http_status || '-';
                const details = event.details || '-';
                const workerId = event.worker_id || '-';
                
                return `
                    <tr>
                        <td>${timestamp}</td>
                        <td><code>${event.signal_id.substring(0, 8)}...</code></td>
                        <td><strong>${event.ticker || '-'}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${locationBadge}</td>
                        <td><small>${workerId}</small></td>
                        <td><small>${details}</small></td>
                        <td>${httpStatus}</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }
        
        // Get status badge HTML
        function getStatusBadge(status) {
            const statusColors = {
                'RECEIVED': 'bg-info',
                'APPROVED': 'bg-success',
                'REJECTED': 'bg-warning',
                'FORWARDED_SUCCESS': 'bg-success',
                'FORWARDED_HTTP_ERROR': 'bg-danger',
                'FORWARDED_GENERIC_ERROR': 'bg-danger',
                'ERROR': 'bg-danger',
                'PROCESSING': 'bg-primary',
                'FORWARDING': 'bg-info'
            };
            
            const color = statusColors[status] || 'bg-secondary';
            return `<span class="badge ${color}">${status}</span>`;
        }
        
        // Get location badge HTML
        function getLocationBadge(location) {
            const locationColors = {
                'PROCESSING_QUEUE': 'bg-primary',
                'APPROVED_QUEUE': 'bg-warning',
                'WORKER_PROCESSING': 'bg-info',
                'WORKER_FORWARDING': 'bg-info',
                'COMPLETED': 'bg-success',
                'DISCARDED': 'bg-secondary'
            };
            
            const color = locationColors[location] || 'bg-secondary';
            return `<span class="badge ${color}">${location}</span>`;
        }
        
        // Update pagination controls
        function updatePagination(data) {
            const resultsInfo = document.getElementById('auditResultsInfo');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            const limit = parseInt(document.getElementById('limitSelect').value);
            const total = data.total || 0;
            const hasMore = data.has_more || false;
            
            resultsInfo.textContent = `Exibindo ${data.events?.length || 0} de ${total} eventos`;
            pageInfo.textContent = `Página ${currentPage}`;
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = !hasMore;
        }
        
        // Bind event handlers
        function bindEventHandlers() {
            // Control buttons
            document.getElementById('pauseEngineBtn').addEventListener('click', () => sendControlCommand('/admin/engine/pause', 'Engine pausado'));
            document.getElementById('resumeEngineBtn').addEventListener('click', () => sendControlCommand('/admin/engine/resume', 'Engine retomado'));
            document.getElementById('refreshEngineBtn').addEventListener('click', () => sendControlCommand('/admin/engine/manual-refresh', 'Atualização de tickers iniciada'));
            document.getElementById('resetMetricsBtn').addEventListener('click', () => sendControlCommand('/admin/metrics/reset', 'Métricas resetadas'));
            document.getElementById('pauseRateLimiterBtn').addEventListener('click', () => sendControlCommand('/admin/webhook-rate-limiter/pause', 'Rate Limiter pausado'));
            document.getElementById('resumeRateLimiterBtn').addEventListener('click', () => sendControlCommand('/admin/webhook-rate-limiter/resume', 'Rate Limiter retomado'));
            
            // Sell all buttons
            document.getElementById('executeSellAllBtn').addEventListener('click', executeSellAll);
            document.getElementById('refreshSellAllBtn').addEventListener('click', loadSellAllList);
            
            // Audit trail controls
            document.getElementById('applyFiltersBtn').addEventListener('click', () => {
                currentPage = 1;
                loadAuditTrail();
            });
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadAuditTrail();
                }
            });
            document.getElementById('nextPageBtn').addEventListener('click', () => {
                currentPage++;
                loadAuditTrail();
            });
        }
        
        // Send control command
        async function sendControlCommand(endpoint, successMessage) {
            try {
                // Get admin token if needed
                let token = localStorage.getItem('admin_token');
                if (!token) {
                    token = prompt('Digite o token de administrador:');
                    if (!token) {
                        showAlert('Token necessário para executar comandos administrativos', 'warning');
                        return;
                    }
                    localStorage.setItem('admin_token', token);
                }

                const response = await fetch(endpoint, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token: token })
                });
                
                if (response.ok) {
                    showAlert(successMessage, 'success');
                    // Refresh status after a short delay
                    setTimeout(loadSystemStatus, 1000);
                } else if (response.status === 403) {
                    // Clear invalid token
                    localStorage.removeItem('admin_token');
                    showAlert('Token inválido. Tente novamente.', 'danger');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error(`Error sending command to ${endpoint}:`, error);
                showAlert(`Erro ao executar comando: ${error.message}`, 'danger');
            }
        }
        
        // Execute sell all
        async function executeSellAll() {
            if (!confirm('Tem certeza que deseja executar SELL ALL? Esta ação irá vender todas as posições na lista.')) {
                return;
            }
            
            try {
                // Get admin token
                let token = localStorage.getItem('admin_token');
                if (!token) {
                    token = prompt('Digite o token de administrador:');
                    if (!token) {
                        showAlert('Token necessário para executar SELL ALL', 'warning');
                        return;
                    }
                    localStorage.setItem('admin_token', token);
                }

                const response = await fetch('/admin/order/sell-all', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showAlert(`Sell All executado com sucesso! ${data.signals_sent || data.processed_tickers || 'N/A'} sinais enviados.`, 'success');
                    loadSellAllList();
                } else if (response.status === 403) {
                    localStorage.removeItem('admin_token');
                    showAlert('Token inválido. Tente novamente.', 'danger');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error executing sell all:', error);
                showAlert(`Erro ao executar Sell All: ${error.message}`, 'danger');
            }
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('tickerFilter').value = '';
            document.getElementById('hourFilter').value = '';
            currentPage = 1;
            loadAuditTrail();
        }
        
        // Show alert
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
        
        // Format uptime
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) {
                return `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
    </script>
</body>
</html>
