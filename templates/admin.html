<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Signal Processor - Admin Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bs-primary: #0d6efd;
            --bs-success: #198754;
            --bs-warning: #ffc107;
            --bs-danger: #dc3545;
            --bs-info: #0dcaf0;
            --bs-dark: #212529;
            --bs-light: #f8f9fa;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .status-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: var(--bs-success);
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background-color: var(--bs-danger);
        }
        
        .status-paused {
            background-color: var(--bs-warning);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .audit-table {
            font-size: 0.875rem;
        }
        
        .badge-status {
            font-size: 0.75rem;
        }
        
        .refresh-btn {
            transition: transform 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: rotate(180deg);
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 200px;
        }
        
        .filter-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 20px;
        }
        
        .section-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .action-buttons .btn {
            margin: 0 5px 10px 0;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .table-responsive {
            max-height: 500px;
        }
        
        .progress-container {
            margin: 10px 0;
        }
        
        .alert-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1040;
            max-width: 400px;
        }
        
        .sell-all-ticker {
            margin: 2px;
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 0.875rem;
            display: inline-block;
        }
        
        .clickable-ticker {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .clickable-ticker:hover {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
            transform: translateY(-1px);
        }
        
        .top-n-ticker {
            margin: 2px;
            padding: 4px 8px;
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            font-size: 0.875rem;
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .top-n-ticker:hover {
            background: #b8daff;
            border-color: #6ba6cd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .top-n-ticker:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* Database Management Discrete Controls */
        .database-actions {
            border-left: 1px solid #dee2e6;
            padding-left: 12px;
        }
        
        .database-actions .btn {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .database-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .database-actions .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .database-actions .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        #csvFileName {
            font-size: 0.75rem;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* New styles for strategy management */
        .strategy-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
        }
        
        .strategy-card:hover {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .strategy-card.active {
            border-color: #198754;
            background-color: #f8fff9;
        }
        
        /* Active Strategy indicator styles */
        .active-strategy-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #0dcaf0;
            transition: all 0.3s ease;
        }
        
        .active-strategy-container:hover {
            border-left-color: #0a58ca;
            box-shadow: 0 2px 8px rgba(13, 202, 240, 0.2);
        }
        
        .strategy-status-icon {
            animation: pulse-info 2s infinite;
        }
        
        @keyframes pulse-info {
            0% { color: #0dcaf0; }
            50% { color: #0a58ca; }
            100% { color: #0dcaf0; }
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #198754;
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .badge-status {
            font-size: 0.8rem;
        }
        
        /* Tab content styling */
        .tab-content {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            padding: 1rem;
        }
        
        /* Modal improvements */
        .modal-xl {
            max-width: 1200px;
        }
        
        /* Table improvements for admin actions */
        .table-sm th,
        .table-sm td {
            padding: 0.5rem 0.25rem;
            font-size: 0.875rem;
        }
        
        .table-responsive {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 1020;
        }
    </style>
</head>
<body>
    <!-- Connection Status Alert -->
    <div id="connectionStatus" class="connection-status">
        <div class="alert alert-info alert-dismissible" role="alert">
            <i class="bi bi-wifi"></i> Connecting to server...
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
    
    <!-- Alert Container -->
    <div id="alertContainer" class="alert-container"></div>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up-arrow"></i>
                Trading Signal Processor
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span id="connectionIndicator" class="status-indicator status-offline"></span>
                    <span id="connectionText">Disconnected</span>
                </span>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-primary" id="signalsReceived">-</div>
                        <div class="metric-label">Signals Received</div>
                        <small class="text-muted">Total since start</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-success" id="signalsApproved">-</div>
                        <div class="metric-label">Signals Approved</div>
                        <small class="text-muted">Passed Top-N filter</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-warning" id="signalsRejected">-</div>
                        <div class="metric-label">Signals Rejected</div>
                        <small class="text-muted">Did not pass filter</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card text-center">
                    <div class="card-body">
                        <div class="metric-value text-info" id="signalsForwarded">-</div>
                        <div class="metric-label">Signals Forwarded</div>
                        <small class="text-muted">Successfully sent</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Queue Status and System Info -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-queue"></i> Queue Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="metric-value text-primary" id="processingQueueSize">-</div>
                                <div class="metric-label">Processing Queue</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value text-warning" id="approvedQueueSize">-</div>
                                <div class="metric-label">Forwarding Queue</div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="d-flex justify-content-between small">
                                <span>Processing Workers:</span>
                                <span id="processingWorkersActive">-</span>
                            </div>
                            <div class="progress mb-2">
                                <div id="processingWorkerProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="d-flex justify-content-between small">
                                <span>Forwarding Workers:</span>
                                <span id="forwardingWorkersActive">-</span>
                            </div>
                            <div class="progress">
                                <div id="forwardingWorkerProgress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle"></i> System
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <strong>Engine Status:</strong><br>
                                <span id="engineStatus" class="badge badge-status">-</span>
                            </div>
                            <div class="col-6">
                                <strong>Rate Limiter:</strong><br>
                                <span id="rateLimiterStatus" class="badge badge-status">-</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <strong>Top-N Tickers:</strong><br>
                                <span id="tickerCount">-</span>
                            </div>
                            <div class="col-6">
                                <strong>Uptime:</strong><br>
                                <span id="uptime">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-bar-chart"></i> Signals per Hour
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="signalsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-pie-chart"></i> Approval Rate
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="approvalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Control Actions and Reprocessing -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-gear"></i> System Controls
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="action-buttons">
                            <button id="pauseEngineBtn" class="btn btn-warning btn-sm">
                                <i class="bi bi-pause"></i> Pause Engine
                            </button>
                            <button id="resumeEngineBtn" class="btn btn-success btn-sm">
                                <i class="bi bi-play"></i> Resume Engine
                            </button>
                            <button id="refreshEngineBtn" class="btn btn-info btn-sm">
                                <i class="bi bi-arrow-clockwise refresh-btn"></i> Refresh Tickers
                            </button>
                            <button id="resetMetricsBtn" class="btn btn-secondary btn-sm">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset Metrics
                            </button>
                            <button id="pauseRateLimiterBtn" class="btn btn-warning btn-sm">
                                <i class="bi bi-pause"></i> Pause Rate Limiter
                            </button>
                            <button id="resumeRateLimiterBtn" class="btn btn-success btn-sm">
                                <i class="bi bi-play"></i> Resume Rate Limiter
                            </button>
                        </div>
                        <hr>
                        <!-- Signal Reprocessing Engine section REMOVED - now configured per Finviz Strategy -->
                        <div class="alert alert-info border-0" style="background-color: #e3f2fd;">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-info-circle-fill me-2" style="color: #1976d2;"></i>
                                <div>
                                    <strong>Signal Reprocessing Configuration</strong><br>
                                    <small>Reprocessing is now configured per strategy. Use <strong>Configuration Modal â†’ Finviz Strategies</strong> to set reprocessing parameters for each strategy individually.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-gear-fill"></i> Configuration & Strategy
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Active Strategy Section -->
                        <div class="active-strategy-container p-3 rounded mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-bar-chart strategy-status-icon me-2 fs-5"></i>
                                <h6 class="mb-0 text-dark fw-semibold">Active Strategy</h6>
                            </div>
                            <div id="activeStrategyIndicator" class="ms-4">
                                <div class="fw-bold text-dark mb-1 fs-6" id="activeStrategyName">Loading...</div>
                                <div class="text-muted small" id="activeStrategyDescription">Loading strategy information...</div>
                            </div>
                        </div>
                        
                        <!-- Configuration Actions -->
                        <div class="d-grid gap-2">
                            <button id="openConfigBtn" class="btn btn-primary">
                                <i class="bi bi-sliders me-2"></i> Open Configuration Panel
                            </button>
                            <button id="setTokenBtn" class="btn btn-outline-secondary">
                                <i class="bi bi-key me-2"></i> Set Admin Token
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top-N Tickers List and Sell All Management -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-star-fill"></i> Top-N Approved Tickers
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Current List (<span id="topNTickerCount">0</span> tickers):</h6>
                            <button id="refreshTopNBtn" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        <div id="topNTickers" class="mb-3" style="max-height: 200px; overflow-y: auto;">
                            <span class="text-muted">Loading...</span>
                        </div>
                        <small class="text-success">
                            <i class="bi bi-info-circle"></i> 
                            Click on any ticker to add it to Sell All list
                        </small>
                        <br>
                        <small class="text-muted">
                            <i class="bi bi-shield-check"></i> 
                            Only signals from these tickers will be approved and forwarded
                        </small>
                        <div id="topNLastUpdate" class="mt-2">
                            <small class="text-muted">Last Update: <span id="topNTimestamp">-</span></small>
                        </div>
                        
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!-- Sell All Management -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-check"></i> Sell All Management
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Manual Ticker Addition -->
                        <div class="mb-3">
                            <h6>Add Ticker Manually:</h6>
                            <div class="input-group">
                                <input type="text" id="manualTickerInput" class="form-control" placeholder="Enter ticker (e.g., AAPL)" style="text-transform: uppercase;">
                                <button id="addTickerBtn" class="btn btn-outline-primary">
                                    <i class="bi bi-plus-circle"></i> Add
                                </button>
                            </div>
                        </div>
                        
                        <!-- Individual Sell Order -->
                        <div class="mb-3">
                            <h6>Individual Sell Order:</h6>
                            <div class="input-group">
                                <input type="text" id="sellIndividualInput" class="form-control" placeholder="Enter ticker to sell" style="text-transform: uppercase;">
                                <button id="sellIndividualBtn" class="btn btn-warning">
                                    <i class="bi bi-arrow-down-circle"></i> Sell
                                </button>
                            </div>
                        </div>
                        
                        <!-- Current Sell All List -->
                        <div class="mb-3">
                            <h6>Tickers in Sell All List:</h6>
                            <div id="sellAllTickers" style="max-height: 150px; overflow-y: auto;">
                                <span class="text-muted">Loading...</span>
                            </div>
                        </div>
                        
                        <!-- Cleanup Settings -->
                        <div id="sellAllCleanupContainer" class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Cleanup Settings:</h6>
                                <span id="sellAllCleanupStatus" class="badge bg-secondary fs-6">UNKNOWN</span>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" role="switch" id="cleanupEnabledSwitch">
                                <label class="form-check-label" for="cleanupEnabledSwitch">Enable Automatic Cleanup</label>
                            </div>
                            <div class="mb-2">
                                <label for="lifetimeHoursInput" class="form-label">Ticker Lifetime (hours)</label>
                                <input type="number" id="lifetimeHoursInput" class="form-control" min="1">
                                <small class="form-text text-muted">A ticker will be removed from the list after this many hours.</small>
                            </div>
                            <button id="saveCleanupConfigBtn" class="btn btn-outline-primary btn-sm w-100">
                                <i class="bi bi-save"></i> Save Cleanup Settings
                            </button>
                        </div>

                        <div class="d-grid gap-2">
                            <button id="executeSellAllBtn" class="btn btn-danger">
                                <i class="bi bi-exclamation-triangle"></i> Execute Sell All
                            </button>
                            <!-- ADD THIS NEW ROW FOR CLEAR AND REFRESH -->
                            <div class="btn-group">
                                 <button id="clearSellAllBtn" class="btn btn-outline-warning w-50">
                                    <i class="bi bi-trash"></i> Clear List Now
                                </button>
                                <button id="refreshSellAllBtn" class="btn btn-outline-secondary w-50">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh List
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Audit Trail -->
        <div class="row mt-4"> <!-- Added mt-4 for spacing -->
            <!-- Orders Section -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-graph-up-arrow"></i> Real-Time Orders
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filtros -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select id="orderStatusFilter" class="form-select">
                                    <option value="all">All Orders</option>
                                    <option value="open">Open</option>
                                    <option value="closing">Closing</option>
                                    <option value="closed">Closed</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" id="orderTickerFilter" class="form-control" placeholder="Filter by ticker...">
                            </div>
                            <div class="col-md-4">
                                <button id="refreshOrdersBtn" class="btn btn-outline-primary">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        
                        <!-- Real-Time Counters -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="alert alert-success mb-0">
                                    <strong id="openOrdersCount">0</strong> Open
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="alert alert-warning mb-0">
                                    <strong id="closingOrdersCount">0</strong> Closing
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="alert alert-secondary mb-0">
                                    <strong id="closedTodayCount">0</strong> Today
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="alert alert-info mb-0">
                                    <strong id="totalValueCount">$0</strong> Total
                                </div>
                            </div>
                        </div>
                        
                        <!-- Orders List -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="ordersTable">
                                <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Status</th>
                                        <th>Entry</th>
                                        <th>Exit</th>
                                        <th>Duration</th>
                                        <th>Value</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            Loading orders...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Trail Section -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-journal-text"></i> Audit Trail
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="filter-card p-3 mb-3">
                            <div class="row">
                                <div class="col-md-2">
                                    <label for="limitSelect" class="form-label">Limit:</label>
                                    <select id="limitSelect" class="form-select form-select-sm">
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="1000">1000</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="statusFilter" class="form-label">Status:</label>
                                    <select id="statusFilter" class="form-select form-select-sm">
                                        <option value="">All</option>
                                        <option value="RECEIVED">Received</option>
                                        <option value="APPROVED">Approved</option>
                                        <option value="REJECTED">Rejected</option>
                                        <option value="FORWARDED_SUCCESS">Forwarded</option>
                                        <option value="FORWARDED_HTTP_ERROR">HTTP Error</option>
                                        <option value="ERROR">Error</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="signalTypeFilter" class="form-label">Type:</label>
                                    <select id="signalTypeFilter" class="form-select form-select-sm">
                                        <option value="">All</option>
                                        <option value="buy">Buy</option>
                                        <option value="sell">Sell</option>
                                        <option value="manual_sell">Manual Sell</option>
                                        <option value="sell_all">Sell All</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="tickerFilter" class="form-label">Ticker:</label>
                                    <input type="text" id="tickerFilter" class="form-control form-control-sm" placeholder="e.g., AAPL">
                                </div>
                                <div class="col-md-2">
                                    <label for="signalIdFilter" class="form-label">Signal ID:</label>
                                    <input type="text" id="signalIdFilter" class="form-control form-control-sm" placeholder="e.g., c88c6d90">
                                </div>
                                <div class="col-md-2">
                                    <label for="hourFilter" class="form-label">Last hours:</label>
                                    <select id="hourFilter" class="form-select form-select-sm">
                                        <option value="">All</option>
                                        <option value="1">1 hour</option>
                                        <option value="6">6 hours</option>
                                        <option value="24">24 hours</option>
                                        <option value="168">7 days</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button id="applyFiltersBtn" class="btn btn-primary btn-sm">
                                            <i class="bi bi-funnel"></i> Filter
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button id="clearFiltersBtn" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-x-circle"></i> Clear
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">Database Actions</label>
                                    <div class="d-flex gap-1 database-actions">
                                        <button id="downloadCsvBtn" class="btn btn-outline-info btn-sm" title="Download Full Database (CSV)">
                                            <i class="bi bi-download"></i>
                                        </button>
                                        <input type="file" class="form-control form-control-sm d-none" id="csvUploadInput" accept=".csv">
                                        <button id="selectCsvBtn" class="btn btn-outline-warning btn-sm" title="Select CSV file to upload">
                                            <i class="bi bi-folder2-open"></i>
                                        </button>
                                        <button id="uploadCsvBtn" class="btn btn-outline-success btn-sm" title="Upload selected CSV" disabled>
                                            <i class="bi bi-upload"></i>
                                        </button>
                                        <button id="clearDatabaseBtn" class="btn btn-outline-danger btn-sm" title="Clear All Database Records">
                                            <i class="bi bi-trash3"></i>
                                        </button>
                                        <small class="text-muted align-self-center ms-2" id="csvFileName"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audit Table -->
                        <div class="table-responsive">
                            <table class="table table-hover table-sm audit-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Signal ID</th>
                                        <th>Ticker</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Location</th>
                                        <th>Worker</th>
                                        <th>Details</th>
                                        <th>HTTP</th>
                                    </tr>
                                </thead>
                                <tbody id="auditTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="loading-spinner spinner-border" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            Loading audit data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="text-muted">
                                <span id="auditResultsInfo">-</span>
                            </div>
                            <div>
                                <button id="prevPageBtn" class="btn btn-outline-secondary btn-sm me-2" disabled>
                                    <i class="bi bi-chevron-left"></i> Previous
                                </button>
                                <span id="pageInfo" class="mx-2">Page 1</span>
                                <button id="nextPageBtn" class="btn btn-outline-secondary btn-sm ms-2" disabled>
                                    Next <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // =========================================================================
        // GLOBAL VARIABLES & STATE
        // =========================================================================
        let socket = null;
        let signalsChart = null;
        let approvalChart = null;
        let auditCurrentPage = 1;
        let auditIsLoading = false;
        // isInteractingWithReprocessing removed - reprocessing now per-strategy configuration
        let isInteractingWithCleanup = false;

        // State for orders and strategies
        let ordersData = [];
        let ordersFilters = { status: 'all', ticker: '' };
        let strategiesData = [];
        let currentEditingStrategyId = null;

        // Admin actions log variables
        let adminActionsCurrentPage = 1;
        let adminActionsLoading = false;
        const adminActionsPageSize = 25;

        // =========================================================================
        // INITIALIZATION
        // =========================================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting initialization...');
            
            // Initialize WebSocket and core systems
            initializeWebSocket();
            initializeCharts();
            
            // Load initial data
            loadInitialData();
            bindEventHandlers();

            // Auto-refresh key components periodically
            setInterval(() => {
                if (!document.hidden) { // Only refresh if tab is active
                    loadAuditTrail();
                    updateOrdersStats();
                    loadAdminActionsLog();
                    // Also refresh active strategy indicator
                    loadActiveStrategyIndicator();
                }
            }, 30000);
            
            console.log('Application initialization completed');
        });

        // =========================================================================
        // CORE APPLICATION LOGIC
        // =========================================================================

        /**
         * Initializes the WebSocket connection and sets up handlers.
         */
        function initializeWebSocket() {
            if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
                return; // Already connected or connecting
            }
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/admin-updates`;

            socket = new WebSocket(wsUrl);

            socket.onopen = () => updateConnectionStatus(true);
            socket.onclose = () => {
                updateConnectionStatus(false);
                setTimeout(initializeWebSocket, 5000); // Reconnect logic
            };
            socket.onerror = () => updateConnectionStatus(false);
            socket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error("Error parsing WebSocket message:", error);
                }
            };
        }

        /**
         * Loads all initial data for the dashboard.
         */
        async function loadInitialData() {
            console.log('Loading initial dashboard data...');
            try {
                const loadPromises = [
                    loadSystemStatus(),
                    loadSellAllList(),
                    loadTopNTickers(),
                    loadAuditTrail(),
                    loadOrders(),
                    updateOrdersStats(),
                    loadCleanupConfig(),
                    // loadReprocessingHealth() removed - reprocessing now per-strategy
                    loadAdminActionsLog(),
                    updateChartsWithData(),
                    loadActiveStrategyIndicator(),
                    loadFinvizStrategies() // Ensure strategies are loaded on startup
                ];
                
                // Load all data in parallel but handle errors gracefully
                const results = await Promise.allSettled(loadPromises);
                
                // Log any failed loads
                results.forEach((result, index) => {
                    if (result.status === 'rejected') {
                        const functionNames = [
                            'loadSystemStatus', 'loadSellAllList', 'loadTopNTickers', 
                            'loadAuditTrail', 'loadOrders', 'updateOrdersStats',
                            'loadCleanupConfig', 'loadAdminActionsLog',
                            // 'loadReprocessingHealth' removed - reprocessing now per-strategy
                            'updateChartsWithData', 'loadActiveStrategyIndicator', 'loadFinvizStrategies'
                        ];
                        console.warn(`Failed to load ${functionNames[index]}:`, result.reason);
                    }
                });
                
                console.log('Initial dashboard data loaded successfully');
            } catch (error) {
                console.error('Error in loadInitialData:', error);
                showAlert('Error loading initial dashboard data.', 'danger');
            }
        }

        /**
         * Binds all event handlers for UI elements.
         */
        function bindEventHandlers() {
            // System Controls
            document.getElementById('pauseEngineBtn')?.addEventListener('click', () => sendControlCommand('/admin/engine/pause', 'Engine paused'));
            document.getElementById('resumeEngineBtn')?.addEventListener('click', () => sendControlCommand('/admin/engine/resume', 'Engine resumed'));
            document.getElementById('refreshEngineBtn')?.addEventListener('click', () => sendControlCommand('/admin/engine/manual-refresh', 'Ticker refresh triggered'));
            document.getElementById('resetMetricsBtn')?.addEventListener('click', () => sendControlCommand('/admin/metrics/reset', 'Metrics reset successfully'));
            document.getElementById('pauseRateLimiterBtn')?.addEventListener('click', () => sendControlCommand('/admin/webhook-rate-limiter/pause', 'Rate Limiter paused'));
            document.getElementById('resumeRateLimiterBtn')?.addEventListener('click', () => sendControlCommand('/admin/webhook-rate-limiter/resume', 'Rate Limiter resumed'));

            // Sell All & Top-N Management
            document.getElementById('executeSellAllBtn')?.addEventListener('click', executeSellAll);
            document.getElementById('addTickerBtn')?.addEventListener('click', addTickerToSellAll);
            document.getElementById('sellIndividualBtn')?.addEventListener('click', executeIndividualSell);
            document.getElementById('clearSellAllBtn')?.addEventListener('click', clearSellAllList);
            document.getElementById('refreshSellAllBtn')?.addEventListener('click', loadSellAllList);
            document.getElementById('refreshTopNBtn')?.addEventListener('click', loadTopNTickers);

            // Reprocessing Controls REMOVED - now configured per Finviz Strategy
            // Use Configuration Modal > Finviz Strategies Tab to configure reprocessing
            // document.getElementById('reprocessingModeSelect')?.addEventListener('change', handleReprocessingModeChange);
            // document.getElementById('applyReprocessingConfigBtn')?.addEventListener('click', applyReprocessingConfig);

            // Cleanup Controls
            document.getElementById('saveCleanupConfigBtn')?.addEventListener('click', saveCleanupConfig);

            // Audit Trail Controls
            document.getElementById('applyFiltersBtn')?.addEventListener('click', () => { auditCurrentPage = 1; loadAuditTrail(); });
            document.getElementById('clearFiltersBtn')?.addEventListener('click', clearFilters);
            document.getElementById('prevPageBtn')?.addEventListener('click', () => { if (auditCurrentPage > 1) { auditCurrentPage--; loadAuditTrail(); } });
            document.getElementById('nextPageBtn')?.addEventListener('click', () => { auditCurrentPage++; loadAuditTrail(); });

            // Database Management
            document.getElementById('downloadCsvBtn')?.addEventListener('click', downloadDatabaseCsv);
            document.getElementById('selectCsvBtn')?.addEventListener('click', () => document.getElementById('csvUploadInput')?.click());
            document.getElementById('csvUploadInput')?.addEventListener('change', handleCsvFileSelection);
            document.getElementById('uploadCsvBtn')?.addEventListener('click', uploadDatabaseCsv);
            document.getElementById('clearDatabaseBtn')?.addEventListener('click', clearDatabase);

            // Orders Management
            document.getElementById('orderStatusFilter')?.addEventListener('change', (e) => { ordersFilters.status = e.target.value; loadOrders(); });
            document.getElementById('orderTickerFilter')?.addEventListener('input', (e) => { 
                ordersFilters.ticker = e.target.value; 
                clearTimeout(window.tickerFilterTimeout); 
                window.tickerFilterTimeout = setTimeout(loadOrders, 300); 
            });
            document.getElementById('refreshOrdersBtn')?.addEventListener('click', loadOrders);
            
            // Main Config Panel
            document.getElementById('openConfigBtn')?.addEventListener('click', openConfigModal);
            document.getElementById('setTokenBtn')?.addEventListener('click', setAdminToken);

            // Strategy Management in Modals
            document.getElementById('addNewStrategyBtn')?.addEventListener('click', addNewStrategy);
            document.getElementById('saveStrategyBtn')?.addEventListener('click', saveStrategyChanges);
            document.getElementById('configTabs')?.addEventListener('shown.bs.tab', handleTabChange);
            
            // Admin Actions Log Handlers
            const actionFilters = ['actionTypeFilter', 'actionSuccessFilter', 'actionHoursFilter'];
            actionFilters.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.addEventListener('change', () => {
                        adminActionsCurrentPage = 1;
                        loadAdminActionsLog();
                    });
                }
            });
            const adminActionsPrevBtn = document.getElementById('adminActionsPrevBtn');
            const adminActionsNextBtn = document.getElementById('adminActionsNextBtn');
            if (adminActionsPrevBtn) adminActionsPrevBtn.addEventListener('click', () => { if (adminActionsCurrentPage > 1) { adminActionsCurrentPage--; loadAdminActionsLog(); } });
            if (adminActionsNextBtn) adminActionsNextBtn.addEventListener('click', () => { adminActionsCurrentPage++; loadAdminActionsLog(); });
            document.getElementById('exportActionsBtn')?.addEventListener('click', exportAdminActions);
            document.getElementById('refreshActionsBtn')?.addEventListener('click', loadAdminActionsLog);
        }

        // =========================================================================
        // WEBSOCKET MESSAGE HANDLING
        // =========================================================================

        function handleWebSocketMessage(data) {
            if (!data || !data.type) return;

            const handlers = {
                'metrics_update': (d) => updateMetrics(d),
                'status_update': (d) => {
                    if (d.metrics) updateMetrics(d.metrics);
                    if (d.system_info) {
                        updateSystemStatus(d.system_info);
                        updateCleanupCard(d.system_info);
                        updateActiveStrategyIndicator(d.system_info.active_strategy);
                    }
                },
                'sell_all_list_update': (d) => {
                    updateSellAllList(d);
                    loadOrders();
                },
                'order_status_change': (d) => handleOrdersWebSocketMessage(d),
                'metrics_reset': (d) => {
                    updateMetrics(d);
                    showAlert('Metrics reset successfully.', 'info');
                },
                'top_n_tickers_update': (d) => updateTopNTickers(d),
                'finviz_strategy_changed': (d) => {
                    updateActiveStrategyIndicator(d.active_strategy);
                    const configModal = document.getElementById('configModal');
                    if (configModal && configModal.classList.contains('show')) {
                        loadFinvizStrategies();
                    }
                    showAlert(`Strategy activated: ${d.active_strategy?.name || 'Unknown'}`, 'success');
                },
                'admin_action_logged': () => {
                    const logTab = document.querySelector('#admin-log-tab');
                    if (logTab?.classList.contains('active') && adminActionsCurrentPage === 1) {
                        loadAdminActionsLog();
                    }
                }
            };

            if (handlers[data.type] && data.data) {
                handlers[data.type](data.data);
            }
        }

        // =========================================================================
        // UI UPDATE FUNCTIONS (METRICS, STATUS, CHARTS)
        // =========================================================================

        function updateConnectionStatus(isConnected) {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            const alert = document.getElementById('connectionStatus');
            if (isConnected) {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'Connected';
                alert.style.display = 'none';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'Disconnected';
                alert.style.display = 'block';
            }
        }

        function initializeCharts() {
            const signalsCtx = document.getElementById('signalsChart')?.getContext('2d');
            if (signalsCtx) {
                signalsChart = new Chart(signalsCtx, { 
                    type: 'line', 
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: 'Signals Received', 
                            data: [], 
                            borderColor: 'rgb(75, 192, 192)', 
                            tension: 0.1 
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false 
                    } 
                });
            }

            const approvalCtx = document.getElementById('approvalChart')?.getContext('2d');
            if (approvalCtx) {
                approvalChart = new Chart(approvalCtx, { 
                    type: 'doughnut', 
                    data: { 
                        labels: ['Approved', 'Rejected'], 
                        datasets: [{ 
                            data: [0, 0], 
                            backgroundColor: ['#198754', '#ffc107'] 
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false 
                    } 
                });
            }
        }

        async function updateChartsWithData() {
            try {
                const response = await fetch('/admin/signals-history?hours=24');
                const historyData = await response.json();
                if (historyData && historyData.data && signalsChart) {
                    const labels = historyData.data.map(item => item.hour || 'N/A');
                    const signals = historyData.data.map(item => item.signals_received || 0);
                    signalsChart.data.labels = labels;
                    signalsChart.data.datasets[0].data = signals;
                    signalsChart.update();
                }
            } catch (error) {
                console.error("Error updating charts:", error);
            }
        }

        function updateMetrics(metrics) {
            if (!metrics) return;
            
            const signalsReceived = document.getElementById('signalsReceived');
            const signalsApproved = document.getElementById('signalsApproved');
            const signalsRejected = document.getElementById('signalsRejected');
            const signalsForwarded = document.getElementById('signalsForwarded');
            const processingQueueSize = document.getElementById('processingQueueSize');
            const approvedQueueSize = document.getElementById('approvedQueueSize');
            const processingWorkersActive = document.getElementById('processingWorkersActive');
            const forwardingWorkersActive = document.getElementById('forwardingWorkersActive');
            const processingWorkerProgress = document.getElementById('processingWorkerProgress');
            const forwardingWorkerProgress = document.getElementById('forwardingWorkerProgress');
            
            if (signalsReceived) signalsReceived.textContent = metrics.signals_received ?? 0;
            if (signalsApproved) signalsApproved.textContent = metrics.signals_approved ?? 0;
            if (signalsRejected) signalsRejected.textContent = metrics.signals_rejected ?? 0;
            if (signalsForwarded) signalsForwarded.textContent = metrics.signals_forwarded_success ?? metrics.signals_forwarded ?? 0;
            if (processingQueueSize) processingQueueSize.textContent = metrics.processing_queue_size ?? 0;
            if (approvedQueueSize) approvedQueueSize.textContent = metrics.approved_queue_size ?? 0;
            
            const maxProcessingWorkers = 16;
            const maxForwardingWorkers = 5;
            const activeProcessing = metrics.processing_workers_active ?? 0;
            const activeForwarding = metrics.forwarding_workers_active ?? 0;
            
            if (processingWorkersActive) processingWorkersActive.textContent = `${activeProcessing} / ${maxProcessingWorkers}`;
            if (forwardingWorkersActive) forwardingWorkersActive.textContent = `${activeForwarding} / ${maxForwardingWorkers}`;
            
            const procPercent = (activeProcessing / maxProcessingWorkers) * 100;
            const fwdPercent = (activeForwarding / maxForwardingWorkers) * 100;
            
            if (processingWorkerProgress) processingWorkerProgress.style.width = `${procPercent}%`;
            if (forwardingWorkerProgress) forwardingWorkerProgress.style.width = `${fwdPercent}%`;

            if (approvalChart) {
                approvalChart.data.datasets[0].data = [metrics.signals_approved ?? 0, metrics.signals_rejected ?? 0];
                approvalChart.update();
            }
        }

        function updateSystemStatus(info) {
            if (!info) return;
            const engineStatus = document.getElementById('engineStatus');
            const rateLimiterStatus = document.getElementById('rateLimiterStatus');
            const tickerCount = document.getElementById('tickerCount');
            const uptime = document.getElementById('uptime');

            if (engineStatus) {
                engineStatus.className = `badge bg-${info.finviz_engine_paused ? 'warning' : 'success'}`;
                engineStatus.textContent = info.finviz_engine_paused ? 'Paused' : 'Running';
            }
            if (rateLimiterStatus) {
                rateLimiterStatus.className = `badge bg-${info.webhook_rate_limiter_paused ? 'warning' : 'success'}`;
                rateLimiterStatus.textContent = info.webhook_rate_limiter_paused ? 'Paused' : 'Running';
            }
            if (tickerCount) tickerCount.textContent = info.finviz_ticker_count ?? '-';
            if (uptime) uptime.textContent = info.uptime_seconds ? formatUptime(info.uptime_seconds) : '-';
        }

        function formatUptime(seconds) {
            const d = Math.floor(seconds / (3600*24));
            const h = Math.floor(seconds % (3600*24) / 3600);
            const m = Math.floor(seconds % 3600 / 60);
            return `${d}d ${h}h ${m}m`;
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            if (!container) return;
            const alertId = `alert-${Date.now()}`;
            const alertHtml = `<div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            container.insertAdjacentHTML('beforeend', alertHtml);
            setTimeout(() => document.getElementById(alertId)?.remove(), 5000);
        }

        // =========================================================================
        // DATA LOADING AND DISPLAY FUNCTIONS
        // =========================================================================
        
        async function loadSystemStatus() {
            try {
                const response = await fetch('/admin/system-info');
                const data = await response.json();
                
                // Update metrics if available
                if (data.metrics) {
                    updateMetrics(data.metrics);
                }
                
                // Update system status if available
                if (data.system_info) {
                    updateSystemStatus(data.system_info);
                    updateActiveStrategyIndicator(data.system_info.active_strategy);
                }
                
                // Update charts with current data
                updateChartsWithData();
                
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        }

        async function loadSellAllList() {
            try {
                const response = await fetch('/admin/sell-all-queue');
                const data = await response.json();
                updateSellAllList(data);
            } catch (error) {
                console.error('Error loading sell all list:', error);
            }
        }
        
        function updateSellAllList(data) {
            const container = document.getElementById('sellAllTickers');
            if (!container) return;
            if (!data?.tickers?.length) {
                container.innerHTML = '<span class="text-muted">No open positions.</span>';
                return;
            }
            container.innerHTML = data.tickers.map(ticker => `<span class="sell-all-ticker">${escapeHtml(ticker)}</span>`).join('');
        }

        async function loadTopNTickers() {
            try {
                const response = await fetch('/admin/top-n-tickers');
                const data = await response.json();
                updateTopNTickers(data);
            } catch (error) {
                console.error('Error loading Top-N tickers:', error);
            }
        }

        function updateTopNTickers(data) {
            const container = document.getElementById('topNTickers');
            const countEl = document.getElementById('topNTickerCount');
            const timeEl = document.getElementById('topNTimestamp');
            if (!container || !countEl || !timeEl) return;

            if (!data?.tickers?.length) {
                container.innerHTML = '<span class="text-muted">No approved tickers available.</span>';
                countEl.textContent = '0';
                timeEl.textContent = 'N/A';
                return;
            }

            container.innerHTML = data.tickers.map(t => `<span class="top-n-ticker" onclick="addTopNTickerToSellAll('${escapeHtml(t)}')">${escapeHtml(t)}</span>`).join('');
            countEl.textContent = data.count || data.tickers.length;
            timeEl.textContent = data.timestamp ? new Date(data.timestamp * 1000).toLocaleString() : 'N/A';
        }

        function addTopNTickerToSellAll(ticker) {
            if (!ticker) return;
            document.getElementById('manualTickerInput').value = ticker;
            addTickerToSellAll();
        }
        
        async function loadAuditTrail() {
            if (auditIsLoading) return;
            auditIsLoading = true;
            
            const tbody = document.getElementById('auditTableBody');
            if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="text-center"><div class="spinner-border spinner-border-sm"></div></td></tr>';

            try {
                const params = new URLSearchParams();
                
                // Only add parameters if they have values
                const limit = document.getElementById('limitSelect')?.value || 100;
                const offset = (auditCurrentPage - 1) * limit;
                const statusFilter = document.getElementById('statusFilter')?.value;
                const signalType = document.getElementById('signalTypeFilter')?.value;
                const ticker = document.getElementById('tickerFilter')?.value;
                const signalId = document.getElementById('signalIdFilter')?.value;
                const hours = document.getElementById('hourFilter')?.value;
                
                params.append('limit', limit.toString());
                params.append('offset', offset.toString());
                
                if (statusFilter) params.append('status_filter', statusFilter);
                if (signalType) params.append('signal_type', signalType);
                if (ticker) params.append('ticker', ticker);
                if (signalId) params.append('signal_id', signalId);
                if (hours) params.append('hours', hours);
                
                const response = await fetch(`/admin/audit-trail?${params.toString()}`);
                const data = await response.json();
                displayAuditTrail(data);
                updatePagination(data);
            } catch (error) {
                console.error('Error loading audit trail:', error);
                if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading audit trail.</td></tr>';
            } finally {
                auditIsLoading = false;
            }
        }

        function displayAuditTrail(data) {
            const tbody = document.getElementById('auditTableBody');
            if (!tbody) return;
            if (!data?.events?.length) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No events found.</td></tr>';
                return;
            }
            tbody.innerHTML = data.events.map(event => `
                <tr>
                    <td><small>${new Date(event.timestamp).toLocaleString()}</small></td>
                    <td><code>${escapeHtml(event.signal_id).substring(0, 8)}</code></td>
                    <td><strong>${escapeHtml(event.ticker)}</strong></td>
                    <td>${getSignalTypeBadge(event.signal_type)}</td>
                    <td>${getStatusBadge(event.event_type)}</td>
                    <td>${getLocationBadge(event.location)}</td>
                    <td><small>${escapeHtml(event.worker_id) || '-'}</small></td>
                    <td><small>${escapeHtml(event.details) || '-'}</small></td>
                    <td>${event.http_status ?? '-'}</td>
                </tr>
            `).join('');
        }

        // Badge mapping objects to avoid Jinja2 conflicts
        const statusMap = {
            RECEIVED: 'info',
            APPROVED: 'success',
            REJECTED: 'warning',
            FORWARDED_SUCCESS: 'success',
            FORWARDED_HTTP_ERROR: 'danger',
            ERROR: 'danger',
            PROCESSING: 'primary',
            FORWARDING: 'info'
        };
        const locationMap = {
            PROCESSING_QUEUE: 'primary',
            APPROVED_QUEUE: 'warning',
            WORKER_PROCESSING: 'info',
            WORKER_FORWARDING: 'info',
            COMPLETED: 'success',
            DISCARDED: 'secondary'
        };
        const signalTypeMap = {
            buy: 'success',
            sell: 'warning',
            manual_sell: 'info',
            sell_all: 'danger'
        };
        function getStatusBadge(status) {
            return `<span class="badge bg-${statusMap[status] || 'secondary'}">${status}</span>`;
        }
        function getLocationBadge(location) {
            return `<span class="badge bg-${locationMap[location] || 'secondary'}">${location}</span>`;
        }
        function getSignalTypeBadge(type) {
            return `<span class="badge bg-${signalTypeMap[type] || 'secondary'}">${(type || '').replace('_',' ').toUpperCase()}</span>`;
        }
        
        function updatePagination(data) {
            document.getElementById('auditResultsInfo').textContent = `Showing ${data.events?.length || 0} of ${data.total || 0}`;
            document.getElementById('pageInfo').textContent = `Page ${auditCurrentPage}`;
            document.getElementById('prevPageBtn').disabled = auditCurrentPage === 1;
            document.getElementById('nextPageBtn').disabled = !data.has_more;
        }

        function clearFilters() {
            const filters = ['statusFilter', 'signalTypeFilter', 'tickerFilter', 'signalIdFilter', 'hourFilter'];
            filters.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            auditCurrentPage = 1;
            loadAuditTrail();
        }

        // =========================================================================
        // ORDERS MANAGEMENT
        // =========================================================================

        async function loadOrders() {
            try {
                const params = new URLSearchParams();
                if (ordersFilters.status !== 'all') params.append('status', ordersFilters.status);
                if (ordersFilters.ticker) params.append('ticker', ordersFilters.ticker);
                
                const response = await fetch(`/admin/orders?${params.toString()}`);
                const data = await response.json();
                ordersData = data.orders || [];
                updateOrdersTable();
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function updateOrdersTable() {
            const tbody = document.getElementById('ordersTableBody');
            if (!tbody) return;

            if (!ordersData || ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No orders found.</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => {
                const statusBadge = getOrderStatusBadge(order.status);
                const duration = order.duration ? formatDuration(order.duration) : '-';
                const entryPrice = order.entry_price ? `$${order.entry_price.toFixed(2)}` : '-';
                const exitPrice = order.exit_price ? `$${order.exit_price.toFixed(2)}` : '-';
                const value = order.value ? `$${order.value.toFixed(2)}` : '-';
                
                return `
                    <tr>
                        <td><strong>${order.ticker}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${entryPrice}</td>
                        <td>${exitPrice}</td>
                        <td>${duration}</td>
                        <td>${value}</td>
                        <td>
                            ${order.status === 'open' ? `<button class="btn btn-sm btn-warning" onclick="sellOrder('${order.ticker}')">Sell</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getOrderStatusBadge(status) {
            const colors = { 
                'open': 'success', 
                'closing': 'warning', 
                'closed': 'secondary' 
            };
            return `<span class="badge bg-${colors[status] || 'secondary'}">${status.toUpperCase()}</span>`;
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        async function updateOrdersStats() {
            try {
                const response = await fetch('/admin/orders/stats');
                const stats = await response.json();
                
                document.getElementById('openOrdersCount').textContent = stats.open || 0;
                document.getElementById('closingOrdersCount').textContent = stats.closing || 0;
                document.getElementById('closedTodayCount').textContent = stats.closed_today || 0;
                document.getElementById('totalValueCount').textContent = `$${stats.total_value || 0}`;
            } catch (error) {
                console.error('Error loading orders stats:', error);
            }
        }

        function handleOrdersWebSocketMessage(data) {
            loadOrders();
            updateOrdersStats();
        }

        async function sellOrder(ticker) {
            if (!confirm(`Sell position for ${ticker}?`)) return;
            
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const response = await fetch('/admin/order/sell-individual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, ticker })
                });
                
                if (response.ok) {
                    showAlert(`Sell order placed for ${ticker}`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showAlert(`Error selling ${ticker}: ${error.message}`, 'danger');
            }
        }

        // =========================================================================
        // SELL ALL MANAGEMENT
        // =========================================================================

        async function executeSellAll() {
            if (!confirm('Execute Sell All? This will sell all open positions.')) return;
            
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const response = await fetch('/admin/order/sell-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                if (response.ok) {
                    showAlert('Sell All executed successfully', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showAlert(`Error executing Sell All: ${error.message}`, 'danger');
            }
        }

        async function addTickerToSellAll() {
            const input = document.getElementById('manualTickerInput');
            const ticker = input?.value?.trim()?.toUpperCase();
            
            if (!ticker) {
                showAlert('Please enter a ticker symbol', 'warning');
                return;
            }
            
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const response = await fetch('/admin/sell-all-queue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, ticker })
                });
                
                if (response.ok) {
                    showAlert(`${ticker} added to Sell All list`, 'success');
                    if (input) input.value = '';
                    loadSellAllList();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showAlert(`Error adding ticker: ${error.message}`, 'danger');
            }
        }

        async function executeIndividualSell() {
            const input = document.getElementById('sellIndividualInput');
            const ticker = input?.value?.trim()?.toUpperCase();
            
            if (!ticker) {
                showAlert('Please enter a ticker symbol', 'warning');
                return;
            }
            
            if (!confirm(`Sell individual position for ${ticker}?`)) return;
            
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const response = await fetch('/admin/order/sell-individual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, ticker })
                });
                
                if (response.ok) {
                    showAlert(`Individual sell order placed for ${ticker}`, 'success');
                    if (input) input.value = '';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showAlert(`Error selling ${ticker}: ${error.message}`, 'danger');
            }
        }

        async function clearSellAllList() {
            if (!confirm('Clear the entire Sell All list?')) return;
            
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const response = await fetch('/admin/sell-all-queue/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                if (response.ok) {
                    showAlert('Sell All list cleared', 'success');
                    loadSellAllList();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showAlert(`Error clearing list: ${error.message}`, 'danger');
            }
        }

        // =========================================================================
        // SYSTEM CONTROLS
        // =========================================================================

        async function sendControlCommand(endpoint, successMessage) {
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                if (response.ok) {
                    showAlert(successMessage, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'danger');
            }
        }

        // =========================================================================
        // REPROCESSING ENGINE MANAGEMENT - REMOVED
        // =========================================================================
        // Reprocessing is now configured per Finviz Strategy in Configuration Modal
        // Use Configuration Modal > Finviz Strategies Tab to configure reprocessing

        // =========================================================================
        // CLEANUP CONFIGURATION
        // =========================================================================

        async function loadCleanupConfig() {
            try {
                // Check if cleanup config is available in system info instead
                const response = await fetch('/admin/system-info');
                const data = await response.json();
                const systemInfo = data.system_info || {};
                
                const cleanupEnabled = systemInfo.sell_all_cleanup_enabled || false;
                const lifetimeHours = systemInfo.sell_all_cleanup_lifetime_hours || 24;
                
                const enabledSwitch = document.getElementById('cleanupEnabledSwitch');
                const lifetimeInput = document.getElementById('lifetimeHoursInput');
                
                if (enabledSwitch) enabledSwitch.checked = cleanupEnabled;
                if (lifetimeInput) lifetimeInput.value = lifetimeHours;
                
                // Update cleanup status indicator
                const statusEl = document.getElementById('sellAllCleanupStatus');
                if (statusEl) {
                    statusEl.textContent = cleanupEnabled ? 'ENABLED' : 'DISABLED';
                    statusEl.className = `badge fs-6 ${cleanupEnabled ? 'bg-success' : 'bg-secondary'}`;
                }
            } catch (error) {
                console.error('Error loading cleanup config:', error);
                // Set defaults if loading fails
                const enabledSwitch = document.getElementById('cleanupEnabledSwitch');
                const lifetimeInput = document.getElementById('lifetimeHoursInput');
                if (enabledSwitch) enabledSwitch.checked = false;
                if (lifetimeInput) lifetimeInput.value = 24;
            }
        }

        async function saveCleanupConfig() {
            if (isInteractingWithCleanup) return;
            isInteractingWithCleanup = true;
            
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const enabled = document.getElementById('cleanupEnabledSwitch')?.checked;
                const lifetimeHours = parseInt(document.getElementById('lifetimeHoursInput')?.value);
                
                // Use system config endpoint instead of dedicated cleanup endpoint
                const config = {
                    token,
                    sell_all_cleanup_enabled: enabled,
                    sell_all_cleanup_lifetime_hours: lifetimeHours
                };
                
                const response = await fetch('/admin/system/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    showAlert('Cleanup configuration saved', 'success');
                    // Update the status indicator
                    const statusEl = document.getElementById('sellAllCleanupStatus');
                    if (statusEl) {
                        statusEl.textContent = enabled ? 'ENABLED' : 'DISABLED';
                        statusEl.className = `badge fs-6 ${enabled ? 'bg-success' : 'bg-secondary'}`;
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error saving cleanup config:', error);
                showAlert(`Error saving cleanup config: ${error.message}`, 'danger');
            } finally {
                isInteractingWithCleanup = false;
            }
        }

        function updateCleanupCard(data) {
            // Implementation for updating cleanup status
        }

        // =========================================================================
        // DATABASE MANAGEMENT
        // =========================================================================

        async function downloadDatabaseCsv() {
            try {
                const response = await fetch('/admin/database/export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audit_trail_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showAlert('Database exported successfully', 'success');
            } catch (error) {
                showAlert(`Error exporting database: ${error.message}`, 'danger');
            }
        }

        function handleCsvFileSelection(event) {
            const file = event.target.files[0];
            const uploadBtn = document.getElementById('uploadCsvBtn');
            const fileName = document.getElementById('csvFileName');
            
            if (file) {
                if (uploadBtn) uploadBtn.disabled = false;
                if (fileName) fileName.textContent = file.name;
            } else {
                if (uploadBtn) uploadBtn.disabled = true;
                if (fileName) fileName.textContent = '';
            }
        }

        async function uploadDatabaseCsv() {
            const fileInput = document.getElementById('csvUploadInput');
            const file = fileInput?.files[0];
            
            if (!file) {
                showAlert('Please select a CSV file first', 'warning');
                return;
            }
            
            if (!confirm('Upload database CSV? This will replace existing data.')) return;
            
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('token', token);
                
                const response = await fetch('/admin/database/import', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showAlert('Database imported successfully', 'success');
                    loadAuditTrail();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showAlert(`Error importing database: ${error.message}`, 'danger');
            }
        }

        async function clearDatabase() {
            if (!confirm('Clear entire database? This action cannot be undone.')) return;
            if (!confirm('Are you absolutely sure? All data will be lost.')) return;
            
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const response = await fetch('/admin/database/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                if (response.ok) {
                    showAlert('Database cleared successfully', 'success');
                    loadAuditTrail();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showAlert(`Error clearing database: ${error.message}`, 'danger');
            }
        }

        // =========================================================================
        // FINVIZ STRATEGY MANAGEMENT FUNCTIONS
        // ========================================================================
        
        // Load and display all Finviz strategies
        async function loadFinvizStrategies() {
            console.log('Loading Finviz strategies...');
            
            // Set loading state
            const container = document.getElementById('finvizStrategiesList');
            if (container) {
                container.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <small class="text-muted ms-2">Loading strategies...</small>
                    </div>
                `;
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch('/admin/finviz/strategies', {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('Finviz strategies response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Finviz strategies API error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const responseData = await response.json();
                console.log('Finviz strategies response data:', responseData);
                
                // Handle different response formats
                let strategies = [];
                if (Array.isArray(responseData)) {
                    strategies = responseData;
                } else if (responseData && Array.isArray(responseData.strategies)) {
                    strategies = responseData.strategies;
                } else if (responseData && responseData.data && Array.isArray(responseData.data)) {
                    strategies = responseData.data;
                } else {
                    console.warn('Unexpected response format for strategies:', responseData);
                    strategies = [];
                }
                
                strategiesData = strategies;
                console.log('Processed strategies data:', strategiesData);
                console.log('Strategies count:', strategiesData.length);
                
                renderStrategiesList(strategiesData);
                
                // Update active strategy indicator
                const activeStrategy = strategiesData.find(s => s.is_active) || null;
                updateActiveStrategyIndicator(activeStrategy);
                
            } catch (error) {
                console.error('Error loading Finviz strategies:', error);
                strategiesData = []; // Reset to empty array on error
                const container = document.getElementById('finvizStrategiesList');
                if (container) {
                    if (error.name === 'AbortError') {
                        container.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="bi bi-clock"></i> Request timed out. Please try again.
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadFinvizStrategies()">
                                    <i class="bi bi-arrow-clockwise"></i> Retry
                                </button>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i> Error loading strategies: ${error.message}
                                <br><small>Check browser console for details</small>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadFinvizStrategies()">
                                    <i class="bi bi-arrow-clockwise"></i> Retry
                                </button>
                            </div>
                        `;
                    }
                }
                
                // Update active strategy indicator with null
                updateActiveStrategyIndicator(null);
            }
        }
        
        // Render strategies list
        function renderStrategiesList(strategies) {
            const container = document.getElementById('finvizStrategiesList');
            if (!container) {
                console.warn('finvizStrategiesList container not found in DOM');
                return;
            }
            
            // Ensure strategies is always an array
            if (!Array.isArray(strategies)) {
                console.warn('renderStrategiesList received non-array data:', strategies);
                strategies = [];
            }
            
            if (!strategies || strategies.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No strategies found. Add your first strategy below.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = strategies.map(strategy => {
                const isActive = strategy.is_active;
                const cardClass = isActive ? 'border-success bg-light' : '';
                const activeBadge = isActive ? '<span class="badge bg-success ms-2">ACTIVE</span>' : '';
                
                return `
                    <div class="card mb-2 ${cardClass}">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <strong>${escapeHtml(strategy.name)}</strong>
                                    ${activeBadge}
                                    ${strategy.description ? `<br><small class="text-muted">${escapeHtml(strategy.description)}</small>` : ''}
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">${truncateUrl(strategy.url)}</small>
                                    <br><small class="text-muted">
                                        Top: ${strategy.top_n} | Refresh: ${strategy.refresh_interval_sec}s
                                    </small>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">
                                        Reprocess: ${strategy.reprocess_enabled ? 'âœ“' : 'âœ—'}<br>
                                        Sell Chronology: ${strategy.respect_sell_chronology_enabled ? 'âœ“' : 'âœ—'}
                                    </small>
                                </div>
                                <div class="col-md-3 text-end">
                                    ${!isActive ? `
                                        <button class="btn btn-sm btn-outline-success me-1" onclick="activateStrategy(${strategy.id})" title="Activate Strategy">
                                            <i class="bi bi-play-circle"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editStrategy(${strategy.id})" title="Edit Strategy">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="duplicateStrategy(${strategy.id})" title="Duplicate Strategy">
                                        <i class="bi bi-files"></i>
                                    </button>
                                    ${!isActive ? `
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteStrategy(${strategy.id})" title="Delete Strategy">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update active strategy indicator in the main dashboard
        function updateActiveStrategyIndicator(activeStrategy) {
            console.log('Updating active strategy indicator with:', activeStrategy);
            
            const nameElement = document.getElementById('activeStrategyName');
            const descElement = document.getElementById('activeStrategyDescription');
            
            if (!nameElement || !descElement) {
                console.warn('Active strategy indicator elements not found in DOM');
                return;
            }
            
            if (activeStrategy && activeStrategy.name) {
                console.log('Setting active strategy:', activeStrategy.name);
                nameElement.textContent = activeStrategy.name;
                descElement.textContent = activeStrategy.description || 'No description available';
            } else {
                console.log('No active strategy found, setting default text');
                nameElement.textContent = 'None';
                descElement.textContent = 'No active strategy configured';
            }
        }
        
        // Activate a strategy
        async function activateStrategy(strategyId) {
            if (!confirm('Activate this strategy? The current strategy will be deactivated and the system will restart.')) {
                return;
            }
            
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const response = await fetch(`/admin/finviz/strategies/${strategyId}/activate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                if (response.ok) {
                    showAlert('Strategy activated successfully!', 'success');
                    loadFinvizStrategies(); // Reload strategies list
                    loadSystemStatus(); // Update system status
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error activating strategy:', error);
                showAlert(`Error activating strategy: ${error.message}`, 'danger');
            }
        }
        
        // Edit a strategy
        function editStrategy(strategyId) {
            // Ensure strategiesData is an array
            if (!Array.isArray(strategiesData)) {
                showAlert('Strategies data not available. Please refresh.', 'warning');
                return;
            }
            
            const strategy = strategiesData.find(s => s.id === strategyId);
            if (!strategy) {
                showAlert('Strategy not found', 'danger');
                return;
            }
            
            // Populate edit form
            currentEditingStrategyId = strategyId;
            document.getElementById('editStrategyId').value = strategyId;
            document.getElementById('editStrategyName').value = strategy.name;
            document.getElementById('editStrategyUrl').value = strategy.url;
            document.getElementById('editStrategyDescription').value = strategy.description || '';
            document.getElementById('editStrategyTopN').value = strategy.top_n;
            document.getElementById('editStrategyRefresh').value = strategy.refresh_interval_sec;
            document.getElementById('editStrategyReprocessWindow').value = strategy.reprocess_window_seconds;
            document.getElementById('editStrategySellWindow').value = strategy.sell_chronology_window_seconds;
            document.getElementById('editStrategyReprocessEnabled').checked = strategy.reprocess_enabled;
            document.getElementById('editStrategySellChronologyEnabled').checked = strategy.respect_sell_chronology_enabled;
            
            // Show edit modal
            const editModal = new bootstrap.Modal(document.getElementById('editStrategyModal'));
            editModal.show();
        }
        
        // Save strategy changes
        async function saveStrategyChanges() {
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const strategyId = currentEditingStrategyId;
                const formData = {
                    token,
                    name: document.getElementById('editStrategyName').value.trim(),
                    url: document.getElementById('editStrategyUrl').value.trim(),
                    description: document.getElementById('editStrategyDescription').value.trim() || null,
                    top_n: parseInt(document.getElementById('editStrategyTopN').value),
                    refresh_interval_sec: parseInt(document.getElementById('editStrategyRefresh').value),
                    reprocess_window_seconds: parseInt(document.getElementById('editStrategyReprocessWindow').value),
                    sell_chronology_window_seconds: parseInt(document.getElementById('editStrategySellWindow').value),
                    reprocess_enabled: document.getElementById('editStrategyReprocessEnabled').checked,
                    respect_sell_chronology_enabled: document.getElementById('editStrategySellChronologyEnabled').checked
                };
                
                // Validation
                if (!formData.name || !formData.url) {
                    showAlert('Name and URL are required', 'warning');
                    return;
                }
                
                const response = await fetch(`/admin/finviz/strategies/${strategyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showAlert('Strategy updated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editStrategyModal')).hide();
                    loadFinvizStrategies();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error saving strategy:', error);
                showAlert(`Error saving strategy: ${error.message}`, 'danger');
            }
        }
        
        // Duplicate a strategy
        async function duplicateStrategy(strategyId) {
            const newName = prompt('Enter name for the duplicated strategy:');
            if (!newName || !newName.trim()) return;
            
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const response = await fetch(`/admin/finviz/strategies/${strategyId}/duplicate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, new_name: newName.trim() })
                });
                
                if (response.ok) {
                    showAlert('Strategy duplicated successfully!', 'success');
                    loadFinvizStrategies();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error duplicating strategy:', error);
                showAlert(`Error duplicating strategy: ${error.message}`, 'danger');
            }
        }
        
        // Delete a strategy
        async function deleteStrategy(strategyId) {
            // Ensure strategiesData is an array
            if (!Array.isArray(strategiesData)) {
                showAlert('Strategies data not available. Please refresh.', 'warning');
                return;
            }
            
            const strategy = strategiesData.find(s => s.id === strategyId);
            if (!strategy) return;
            
            if (!confirm(`Delete strategy "${strategy.name}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const response = await fetch(`/admin/finviz/strategies/${strategyId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                if (response.ok) {
                    showAlert('Strategy deleted successfully!', 'success');
                    loadFinvizStrategies();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error deleting strategy:', error);
                showAlert(`Error deleting strategy: ${error.message}`, 'danger');
            }
        }
        
        // Add new strategy
        async function addNewStrategy() {
            try {
                const token = getAdminToken();
                if (!token) return;
                
                const formData = {
                    token,
                    name: document.getElementById('newStrategyName').value.trim(),
                    url: document.getElementById('newStrategyUrl').value.trim(),
                    description: document.getElementById('newStrategyDescription').value.trim() || null,
                    top_n: parseInt(document.getElementById('newStrategyTopN').value),
                    refresh_interval_sec: parseInt(document.getElementById('newStrategyRefresh').value),
                    reprocess_window_seconds: parseInt(document.getElementById('newStrategyReprocessWindow').value),
                    sell_chronology_window_seconds: parseInt(document.getElementById('newStrategySellWindow').value),
                    reprocess_enabled: document.getElementById('newStrategyReprocessEnabled').checked,
                    respect_sell_chronology_enabled: document.getElementById('newStrategySellChronologyEnabled').checked
                };
                
                // Validation
                if (!formData.name || !formData.url) {
                    showAlert('Name and URL are required', 'warning');
                    return;
                }
                
                const response = await fetch('/admin/finviz/strategies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showAlert('Strategy created successfully!', 'success');
                    // Clear form
                    document.getElementById('newStrategyName').value = '';
                    document.getElementById('newStrategyUrl').value = '';
                    document.getElementById('newStrategyDescription').value = '';
                    document.getElementById('newStrategyTopN').value = '100';
                    document.getElementById('newStrategyRefresh').value = '10';
                    document.getElementById('newStrategyReprocessWindow').value = '300';
                    document.getElementById('newStrategySellWindow').value = '300';
                    document.getElementById('newStrategyReprocessEnabled').checked = false;
                    document.getElementById('newStrategySellChronologyEnabled').checked = true;
                    
                    loadFinvizStrategies();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error creating strategy:', error);
                showAlert(`Error creating strategy: ${error.message}`, 'danger');
            }
        }
        
        // ============================================================================
        // ADMIN ACTIONS LOG FUNCTIONS
        // ============================================================================
        
        // Load admin actions log
        async function loadAdminActionsLog() {
            if (adminActionsLoading) return;
            
            adminActionsLoading = true;
            const tbody = document.getElementById('adminActionsTableBody');
            
            try {
                const params = new URLSearchParams();
                
                // Filters
                const actionType = document.getElementById('actionTypeFilter')?.value;
                const success = document.getElementById('actionSuccessFilter')?.value;
                const hours = document.getElementById('actionHoursFilter')?.value;
                
                params.append('limit', adminActionsPageSize);
                params.append('offset', (adminActionsCurrentPage - 1) * adminActionsPageSize);
                
                if (actionType) params.append('action_type_filter', actionType);
                if (success) params.append('success_filter', success === 'true');
                if (hours) params.append('hours', hours);
                
                const response = await fetch(`/admin/actions-log?${params}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // Render table
                tbody.innerHTML = data.actions.map(action => {
                    const timestamp = new Date(action.timestamp).toLocaleString();
                    const statusBadge = action.success 
                        ? '<span class="badge bg-success">Success</span>'
                        : '<span class="badge bg-danger">Failed</span>';
                    const duration = action.execution_time_ms 
                        ? `${action.execution_time_ms}ms` 
                        : '-';
                    
                    const actionTypeBadge = getActionTypeBadge(action.action_type);
                    
                    return `
                        <tr>
                            <td><small>${timestamp}</small></td>
                            <td>${actionTypeBadge}</td>
                            <td><strong>${escapeHtml(action.action_name)}</strong></td>
                            <td><small>${escapeHtml(action.target_resource || '-')}</small></td>
                            <td>${statusBadge}</td>
                            <td><small>${duration}</small></td>
                            <td>
                                ${action.error_message ? `<span class="text-danger small">${escapeHtml(action.error_message.substring(0, 50))}${action.error_message.length > 50 ? '...' : ''}</span>` : ''}
                                ${action.details ? `<br><small class="text-muted">${escapeHtml(JSON.stringify(action.details).substring(0, 50))}...</small>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Update pagination info
                const info = document.getElementById('adminActionsInfo');
                if (info) {
                    info.textContent = `Showing ${data.actions.length} of ${data.total} actions`;
                }
                
                const prevBtn = document.getElementById('adminActionsPrevBtn');
                const nextBtn = document.getElementById('adminActionsNextBtn');
                
                if (prevBtn) prevBtn.disabled = adminActionsCurrentPage === 1;
                if (nextBtn) nextBtn.disabled = data.offset + data.actions.length >= data.total;
                
                // Update counter
                const counter = document.getElementById('adminActionsCount');
                if (counter) counter.textContent = data.total;
                
            } catch (error) {
                console.error('Error loading admin actions:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error loading actions: ${error.message}</td></tr>`;
            } finally {
                adminActionsLoading = false;
            }
        }
        
        // Get action type badge
        function getActionTypeBadge(actionType) {
            const badges = {
                'config_update': 'bg-primary',
                'engine_control': 'bg-warning',
                'url_management': 'bg-info',
                'metrics_reset': 'bg-secondary',
                'database_operation': 'bg-dark',
                'rate_limiter_control': 'bg-success',
                'order_management': 'bg-danger'
            };
            
            const badgeClass = badges[actionType] || 'bg-secondary';
            return `<span class="badge ${badgeClass}">${actionType.replace('_', ' ').toUpperCase()}</span>`;
        }
        
        // Export admin actions to CSV
        async function exportAdminActions() {
            try {
                const params = new URLSearchParams();
                
                // Apply same filters as visualization
                const actionType = document.getElementById('actionTypeFilter')?.value;
                const success = document.getElementById('actionSuccessFilter')?.value;
                const hours = document.getElementById('actionHoursFilter')?.value;
                
                if (actionType) params.append('action_type_filter', actionType);
                if (success) params.append('success_filter', success === 'true');
                if (hours) params.append('hours', hours);
                
                params.append('format', 'csv');
                
                const response = await fetch(`/admin/actions-log/export?${params}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                // Download file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `admin_actions_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showAlert('Admin actions exported successfully!', 'success');
                
            } catch (error) {
                console.error('Error exporting admin actions:', error);
                showAlert(`Error exporting: ${error.message}`, 'danger');
            }
        }
        
        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        
        // ============================================================================
        // DEBUG AND UTILITY FUNCTIONS
        // ============================================================================
        
        // Debug function that can be called from browser console
        window.debugStrategies = function() {
            console.log('=== DEBUG: Strategy loading diagnostics ===');
            console.log('1. Current strategies data:', strategiesData);
            console.log('2. Testing active strategy indicator...');
            loadActiveStrategyIndicator();
            console.log('3. Testing finviz strategies list...');
            loadFinvizStrategies();
            console.log('=== DEBUG END ===');
        };
        
        // Truncate URL for display
        function truncateUrl(url) {
            if (!url) return '-';
            return url.length > 60 ? url.substring(0, 60) + '...' : url;
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // =========================================================================
        // INITIALIZATION AND EVENT BINDINGS
        // ============================================================================
        
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Bind configuration modal events
            const openConfigBtn = document.getElementById('openConfigBtn');
            if (openConfigBtn) {
                openConfigBtn.addEventListener('click', openConfigModal);
            }
            
            // Bind tab change events
            const configTabs = document.getElementById('configTabs');
            if (configTabs) {
                configTabs.addEventListener('click', handleTabChange);
            }
            
            // Bind new strategy button
            const addNewStrategyBtn = document.getElementById('addNewStrategyBtn');
            if (addNewStrategyBtn) {
                addNewStrategyBtn.addEventListener('click', addNewStrategy);
            }
            
            // Bind save strategy button in edit modal
            const saveStrategyBtn = document.getElementById('saveStrategyBtn');
            if (saveStrategyBtn) {
                saveStrategyBtn.addEventListener('click', saveStrategyChanges);
            }
            
            // Bind admin actions log filters
            const actionTypeFilter = document.getElementById('actionTypeFilter');
            const actionSuccessFilter = document.getElementById('actionSuccessFilter');
            const actionHoursFilter = document.getElementById('actionHoursFilter');
            
            if (actionTypeFilter) {
                actionTypeFilter.addEventListener('change', () => {
                    adminActionsCurrentPage = 1;
                    loadAdminActionsLog();
                });
            }
            
            if (actionSuccessFilter) {
                actionSuccessFilter.addEventListener('change', () => {
                    adminActionsCurrentPage = 1;
                    loadAdminActionsLog();
                });
            }
            
            if (actionHoursFilter) {
                actionHoursFilter.addEventListener('change', () => {
                    adminActionsCurrentPage = 1;
                    loadAdminActionsLog();
                });
            }
            
            // Bind admin actions pagination
            const adminActionsPrevBtn = document.getElementById('adminActionsPrevBtn');
            const adminActionsNextBtn = document.getElementById('adminActionsNextBtn');
            
            if (adminActionsPrevBtn) {
                adminActionsPrevBtn.addEventListener('click', () => {
                    if (adminActionsCurrentPage > 1) {
                        adminActionsCurrentPage--;
                        loadAdminActionsLog();
                    }
                });
            }
            
            if (adminActionsNextBtn) {
                adminActionsNextBtn.addEventListener('click', () => {
                    adminActionsCurrentPage++;
                    loadAdminActionsLog();
                });
            }
            
            // Bind export actions button
            const exportActionsBtn = document.getElementById('exportActionsBtn');
            if (exportActionsBtn) {
                exportActionsBtn.addEventListener('click', exportAdminActions);
            }
            
            // Bind refresh actions button
            const refreshActionsBtn = document.getElementById('refreshActionsBtn');
            if (refreshActionsBtn) {
                refreshActionsBtn.addEventListener('click', () => {
                    adminActionsCurrentPage = 1;
                    loadAdminActionsLog();
                });
            }
            
            // Initialize existing token functionality
            const setTokenBtn = document.getElementById('setTokenBtn');
            if (setTokenBtn) {
                setTokenBtn.addEventListener('click', setAdminToken);
            }
            
            // Load saved token if available
            loadSavedToken();
            
            // Initialize system data load
            console.log('Starting initial system data load...');
            loadSystemStatus();
            
            // Load active strategy indicator immediately
            console.log('Loading active strategy indicator...');
            loadActiveStrategyIndicator();
            
            // Initialize WebSocket connection
            console.log('Starting WebSocket initialization...');
            initWebSocket();
            
            // Set up auto-refresh interval for active strategy indicator
            setInterval(() => {
                // Only update if not in a modal
                const modals = document.querySelectorAll('.modal.show');
                if (modals.length === 0) {
                    loadActiveStrategyIndicator();
                }
            }, 30000); // Every 30 seconds
        });
        
        // Load active strategy indicator independently
        async function loadActiveStrategyIndicator() {
            console.log('Loading active strategy indicator...');
            try {
                const response = await fetch('/admin/finviz/strategies/active');
                console.log('Active strategy response:', response.status, response.ok);
                
                if (response.ok) {
                    const responseData = await response.json();
                    console.log('Active strategy response data:', responseData);
                    
                    // Handle the correct response format: {"active_strategy": {...}}
                    let activeStrategy = null;
                    if (responseData && responseData.active_strategy && responseData.active_strategy.name) {
                        activeStrategy = responseData.active_strategy;
                    }
                    
                    console.log('Processed active strategy:', activeStrategy);
                    updateActiveStrategyIndicator(activeStrategy);
                } else if (response.status === 404) {
                    console.log('No active strategy found (404), setting to null');
                    updateActiveStrategyIndicator(null);
                } else {
                    console.warn('Active strategy API returned:', response.status);
                    const errorText = await response.text();
                    console.warn('Error response:', errorText);
                    updateActiveStrategyIndicator(null);
                }
            } catch (error) {
                console.error('Error loading active strategy indicator:', error);
                // Set fallback state
                updateActiveStrategyIndicator(null);
            }
        }
        
        // Auto-refresh admin actions log when tab is visible
        setInterval(() => {
            const logTab = document.querySelector('#admin-log');
            if (logTab && logTab.classList.contains('active') && adminActionsCurrentPage === 1) {
                loadAdminActionsLog();
            }
        }, 30000); // Every 30 seconds

        // =========================================================================
        // CONFIGURATION MODAL FUNCTIONS (UPDATED)
        // ============================================================================
        
        // Initialize new functionality when modal is opened
        function openConfigModal() {
            console.log('Opening configuration modal...');
            const configModal = document.getElementById('configModal');
            if (!configModal) {
                console.warn('Configuration modal not found in DOM');
                showAlert('Configuration modal not available', 'warning');
                return;
            }
            
            const modal = new bootstrap.Modal(configModal);
            modal.show();
            
            // Always load strategies when modal opens (regardless of active tab)
            console.log('Loading strategies immediately on modal open...');
            loadFinvizStrategies();
            
            // Load data for active tab
            const activeTab = document.querySelector('#configTabs .nav-link.active');
            if (activeTab) {
                const target = activeTab.getAttribute('data-bs-target');
                console.log('Active tab target:', target);
                if (target === '#admin-log') {
                    loadAdminActionsLog();
                } else if (target === '#system-config') {
                    loadCurrentConfig();
                }
            }
        }
        
        // Handle tab changes to load data on demand
        function handleTabChange(event) {
            if (!event.target) return;
            
            const target = event.target.getAttribute('data-bs-target');
            console.log('Tab changed to:', target);
            
            if (target === '#finviz-strategies') {
                console.log('Loading Finviz strategies for tab...');
                loadFinvizStrategies();
            } else if (target === '#admin-log') {
                console.log('Loading admin actions log for tab...');
                adminActionsCurrentPage = 1;
                loadAdminActionsLog();
            } else if (target === '#system-config') {
                console.log('Loading system config for tab...');
                loadCurrentConfig();
            }
        }
        
        function setAdminToken() {
            const token = prompt('Enter admin token:');
            if (token) {
                localStorage.setItem('admin_token', token);
                const adminTokenElement = document.getElementById('adminToken');
                if (adminTokenElement) {
                    adminTokenElement.value = token;
                }
                showAlert('Token saved successfully!', 'success');
            }
        }
        
        function getAdminToken() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                showAlert('Please set admin token first', 'warning');
                return null;
            }
            return token;
        }
        
        function loadSavedToken() {
            const savedToken = localStorage.getItem('admin_token');
            if (savedToken) {
                const adminTokenElement = document.getElementById('adminToken');
                if (adminTokenElement) {
                    adminTokenElement.value = savedToken;
                }
            }
        }
        
        async function loadCurrentConfig() {
            try {
                // Load webhook config
                const webhookResponse = await fetch('/admin/webhook/config');
                if (webhookResponse.ok) {
                    const webhookData = await webhookResponse.json();
                    const webhookUrlElement = document.getElementById('webhookUrl');
                    const webhookTimeoutElement = document.getElementById('webhookTimeout');
                    if (webhookUrlElement) webhookUrlElement.value = webhookData.webhook_url || '';
                    if (webhookTimeoutElement) webhookTimeoutElement.value = webhookData.timeout || 5;
                }
                
                // Load rate limiter config (from system status)
                const statusResponse = await fetch('/admin/system-info');
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    const rlInfo = statusData.system_info?.webhook_rate_limiter || {};
                    const maxReqElement = document.getElementById('maxReqPerMin');
                    const rateLimitingElement = document.getElementById('rateLimitingEnabled');
                    if (maxReqElement) maxReqElement.value = rlInfo.max_req_per_min || 60;
                    if (rateLimitingElement) rateLimitingElement.checked = !rlInfo.paused;
                }
                
            } catch (error) {
                console.error('Error loading current config:', error);
                showAlert('Error loading current configurations', 'warning');
            }
        }
        
        // =========================================================================
        // SYSTEM STATUS AND WEBSOCKET FUNCTIONS
        // ============================================================================
        
        // Show alert message
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // ============================================================================
        // WEBSOCKET HANDLERS (UPDATED)
        // ============================================================================
        
        // Initialize WebSocket connection
        function initWebSocket() {
            console.log('Initializing WebSocket connection...');
            
            if (socket) {
                console.log('Closing existing WebSocket connection');
                socket.close();
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/admin-updates`;
            console.log('WebSocket URL:', wsUrl);
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function(event) {
                console.log('âœ… WebSocket connection established successfully');
                updateConnectionStatus('Connected', 'success');
            };
            
            socket.onmessage = function(event) {
                console.log('ðŸ“¨ WebSocket message received:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('âŒ Error parsing WebSocket message:', error, 'Raw data:', event.data);
                }
            };
            
            socket.onclose = function(event) {
                console.log('ðŸ”Œ WebSocket connection closed. Code:', event.code, 'Reason:', event.reason);
                updateConnectionStatus('Disconnected', 'danger');
                
                // Attempt to reconnect after 5 seconds
                console.log('â° Attempting to reconnect in 5 seconds...');
                setTimeout(initWebSocket, 5000);
            };
            
            socket.onerror = function(error) {
                console.error('âŒ WebSocket error:', error);
                updateConnectionStatus('Error', 'danger');
            };
        }
        
        // Handle WebSocket messages for real-time updates
        function handleWebSocketMessage(data) {
            console.log('WebSocket message received:', data);
            
            // Handle system info updates
            if (data.type === 'system_info') {
                // Update metrics if available
                if (data.data.metrics) {
                    updateMetrics(data.data.metrics);
                }
                
                // Update system status if available  
                if (data.data.system_info) {
                    updateSystemStatus(data.data.system_info);
                    updateActiveStrategyIndicator(data.data.system_info.active_strategy);
                }
                
                // Update charts with current data
                updateChartsWithData();
            }
            
            // Handle Finviz strategy changes
            if (data.type === 'finviz_strategy_changed') {
                const activeStrategy = data.data?.active_strategy;
                updateActiveStrategyIndicator(activeStrategy);
                
                // Reload strategies list if modal is open
                const strategiesTab = document.querySelector('#finviz-strategies');
                if (strategiesTab && strategiesTab.classList.contains('active')) {
                    loadFinvizStrategies();
                }
                
                showAlert(`Finviz strategy changed to: ${activeStrategy?.name || 'Unknown'}`, 'info');
            }
            
            // Handle admin action logged
            if (data.type === 'admin_action_logged') {
                // Reload log if we're on the first page
                const logTab = document.querySelector('#admin-log');
                if (logTab && logTab.classList.contains('active') && adminActionsCurrentPage === 1) {
                    loadAdminActionsLog();
                }
                
                // Show notification if action failed
                if (data.data && !data.data.success) {
                    showAlert(`Admin action failed: ${data.data.action_name}`, 'warning');
                }
            }
        }
        
        // Update connection status indicator
        function updateConnectionStatus(status, type) {
            const connectionText = document.getElementById('connectionText');
            const connectionIndicator = document.getElementById('connectionIndicator');
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (connectionText) connectionText.textContent = status;
            
            if (connectionIndicator) {
                connectionIndicator.className = `status-indicator status-${type === 'success' ? 'online' : 'offline'}`;
            }
            
            if (connectionStatus && status === 'Connected') {
                connectionStatus.style.display = 'none';
            } else if (connectionStatus && status !== 'Connected') {
                connectionStatus.style.display = 'block';
            }
        }
    </script>

    <!-- Configuration Modal with Tabs -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalLabel">
                        <i class="bi bi-gear"></i> System Configuration
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs" id="configTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="finviz-strategies-tab" data-bs-toggle="tab" data-bs-target="#finviz-strategies" type="button" role="tab" aria-controls="finviz-strategies" aria-selected="true">
                                <i class="bi bi-bar-chart"></i> Finviz Strategies
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="admin-log-tab" data-bs-toggle="tab" data-bs-target="#admin-log" type="button" role="tab" aria-controls="admin-log" aria-selected="false">
                                <i class="bi bi-shield-check"></i> Admin Actions Log
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="system-config-tab" data-bs-toggle="tab" data-bs-target="#system-config" type="button" role="tab" aria-controls="system-config" aria-selected="false">
                                <i class="bi bi-gear-fill"></i> System Settings
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="configTabContent">
                        <!-- Finviz Strategies Tab -->
                        <div class="tab-pane fade show active" id="finviz-strategies" role="tabpanel" aria-labelledby="finviz-strategies-tab">
                            <div class="mt-4">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-list-ul"></i> Manage Finviz Strategies
                                </h6>
                                
                                <!-- Strategy List -->
                                <div id="finvizStrategiesList" class="mb-4">
                                    <div class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <small class="text-muted ms-2">Loading strategies...</small>
                                    </div>
                                </div>
                                
                                <!-- New Strategy Form -->
                                <div class="card border-light">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="bi bi-plus-circle"></i> Add New Strategy
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col-md-4">
                                                <label for="newStrategyName" class="form-label">Name</label>
                                                <input type="text" class="form-control" id="newStrategyName" placeholder="Ex: High Volume Scanner">
                                            </div>
                                            <div class="col-md-8">
                                                <label for="newStrategyUrl" class="form-label">Finviz URL</label>
                                                <input type="url" class="form-control" id="newStrategyUrl" placeholder="https://finviz.com/screener.ashx?...">
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="newStrategyDescription" class="form-label">Description (optional)</label>
                                            <textarea class="form-control" id="newStrategyDescription" rows="2" placeholder="Strategy description..."></textarea>
                                        </div>
                                        
                                        <!-- Strategy Configuration Parameters -->
                                        <div class="row mb-2">
                                            <div class="col-md-3">
                                                <label for="newStrategyTopN" class="form-label">Top N</label>
                                                <input type="number" class="form-control" id="newStrategyTopN" value="100" min="1" max="1000">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="newStrategyRefresh" class="form-label">Refresh (sec)</label>
                                                <input type="number" class="form-control" id="newStrategyRefresh" value="10" min="5" max="600">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="newStrategyReprocessWindow" class="form-label">Reprocess Window</label>
                                                <input type="number" class="form-control" id="newStrategyReprocessWindow" value="300" min="0">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="newStrategySellWindow" class="form-label">Sell Window</label>
                                                <input type="number" class="form-control" id="newStrategySellWindow" value="300" min="0">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="newStrategyReprocessEnabled">
                                                    <label class="form-check-label" for="newStrategyReprocessEnabled">
                                                        Enable Reprocessing
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="newStrategySellChronologyEnabled" checked>
                                                    <label class="form-check-label" for="newStrategySellChronologyEnabled">
                                                        Respect Sell Chronology
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <button type="button" class="btn btn-success" id="addNewStrategyBtn">
                                            <i class="bi bi-plus-circle"></i> Add Strategy
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Admin Actions Log Tab -->
                        <div class="tab-pane fade" id="admin-log" role="tabpanel" aria-labelledby="admin-log-tab">
                            <div class="mt-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-primary mb-0">
                                        <i class="bi bi-shield-check"></i> Admin Actions Log
                                        <span class="badge bg-info ms-2" id="adminActionsCount">-</span>
                                    </h6>
                                    <button class="btn btn-outline-secondary btn-sm" id="exportActionsBtn">
                                        <i class="bi bi-download"></i> Export CSV
                                    </button>
                                </div>
                                
                                <!-- Filters -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm" id="actionTypeFilter">
                                            <option value="">All Action Types</option>
                                            <option value="config_update">Config Updates</option>
                                            <option value="engine_control">Engine Control</option>
                                            <option value="url_management">URL Management</option>
                                            <option value="metrics_reset">Metrics Reset</option>
                                            <option value="database_operation">Database Operations</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm" id="actionSuccessFilter">
                                            <option value="">All Results</option>
                                            <option value="true">Successful Only</option>
                                            <option value="false">Failed Only</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm" id="actionHoursFilter">
                                            <option value="">All Time</option>
                                            <option value="1">Last Hour</option>
                                            <option value="24">Last 24 Hours</option>
                                            <option value="168">Last 7 Days</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-primary btn-sm w-100" id="refreshActionsBtn">
                                            <i class="bi bi-arrow-clockwise"></i> Refresh
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Actions Table -->
                                <div class="table-responsive" style="max-height: 400px;">
                                    <table class="table table-striped table-hover table-sm">
                                        <thead class="table-dark sticky-top">
                                            <tr>
                                                <th>Timestamp</th>
                                                <th>Action Type</th>
                                                <th>Action Name</th>
                                                <th>Target</th>
                                                <th>Status</th>
                                                <th>Duration</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminActionsTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <small class="text-muted ms-2">Loading actions...</small>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div class="text-muted">
                                        <small id="adminActionsInfo">-</small>
                                    </div>
                                    <div class="btn-group">
                                        <button id="adminActionsPrevBtn" class="btn btn-outline-secondary btn-sm" disabled>
                                            <i class="bi bi-chevron-left"></i> Previous
                                        </button>
                                        <button id="adminActionsNextBtn" class="btn btn-outline-secondary btn-sm" disabled>
                                            Next <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Settings Tab (existing configuration) -->
                        <div class="tab-pane fade" id="system-config" role="tabpanel" aria-labelledby="system-config-tab">
                            <div class="mt-4">
                                <!-- Token Management Section -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-key"></i> Admin Token Management
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="adminToken" placeholder="Enter admin token">
                                                <button class="btn btn-outline-secondary" type="button" id="toggleTokenVisibility">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="btn-group w-100">
                                                <button type="button" class="btn btn-primary" id="saveTokenBtn">
                                                    <i class="bi bi-save"></i> Save
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" id="clearTokenBtn">
                                                    <i class="bi bi-trash"></i> Clear
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Load Current Config Button -->
                                <div class="mb-4">
                                    <button type="button" class="btn btn-info w-100" id="loadCurrentConfigBtn">
                                        <i class="bi bi-download"></i> Load Current Configuration
                                    </button>
                                </div>

                                <!-- Webhook Configuration -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-webhook"></i> Webhook Configuration
                                    </h6>
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <label for="webhookUrl" class="form-label">Webhook URL</label>
                                            <input type="url" class="form-control" id="webhookUrl" placeholder="https://example.com/webhook">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="webhookTimeout" class="form-label">Timeout (seconds)</label>
                                            <input type="number" class="form-control" id="webhookTimeout" min="1" max="60" value="5">
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-success" id="updateWebhookBtn">
                                        <i class="bi bi-check-circle"></i> Update Webhook Config
                                    </button>
                                </div>

                                <!-- Rate Limiter Configuration -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-speedometer2"></i> Rate Limiter Configuration
                                    </h6>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="maxReqPerMin" class="form-label">Max Requests per Minute</label>
                                            <input type="number" class="form-control" id="maxReqPerMin" min="1" max="1000" value="60">
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check form-switch mt-4">
                                                <input class="form-check-input" type="checkbox" role="switch" id="rateLimitingEnabled" checked>
                                                <label class="form-check-label" for="rateLimitingEnabled">
                                                    Enable Rate Limiting
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-success" id="updateRateLimiterBtn">
                                        <i class="bi bi-check-circle"></i> Update Rate Limiter Config
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy Edit Modal -->
    <div class="modal fade" id="editStrategyModal" tabindex="-1" aria-labelledby="editStrategyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStrategyModalLabel">
                        <i class="bi bi-pencil"></i> Edit Strategy
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editStrategyForm">
                        <input type="hidden" id="editStrategyId">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="editStrategyName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="editStrategyName" required>
                            </div>
                            <div class="col-md-8">
                                <label for="editStrategyUrl" class="form-label">Finviz URL</label>
                                <input type="url" class="form-control" id="editStrategyUrl" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editStrategyDescription" class="form-label">Description (optional)</label>
                            <textarea class="form-control" id="editStrategyDescription" rows="2"></textarea>
                        </div>
                        
                        <!-- Strategy Configuration Parameters -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="editStrategyTopN" class="form-label">Top N</label>
                                <input type="number" class="form-control" id="editStrategyTopN" min="1" required>
                            </div>
                            <div class="col-md-3">
                                <label for="editStrategyRefresh" class="form-label">Refresh (sec)</label>
                                <input type="number" class="form-control" id="editStrategyRefresh" min="5" required>
                            </div>
                            <div class="col-md-3">
                                <label for="editStrategyReprocessWindow" class="form-label">Reprocess Window</label>
                                <input type="number" class="form-control" id="editStrategyReprocessWindow" min="0">
                            </div>
                            <div class="col-md-3">
                                <label for="editStrategySellWindow" class="form-label">Sell Window</label>
                                <input type="number" class="form-control" id="editStrategySellWindow" min="0">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editStrategyReprocessEnabled">
                                    <label class="form-check-label" for="editStrategyReprocessEnabled">
                                        Enable Reprocessing
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editStrategySellChronologyEnabled" checked>
                                    <label class="form-check-label" for="editStrategySellChronologyEnabled">
                                        Respect Sell Chronology
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="saveStrategyBtn">
                                <i class="bi bi-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Reprocessing Log Modal -->
    <div class="modal fade" id="reprocessingLogModal" tabindex="-1" aria-labelledby="reprocessingLogModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reprocessingLogModalLabel">
                        <i class="bi bi-clock-history"></i> Reprocessing Log
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Signal ID</th>
                                    <th>Ticker</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="reprocessingLogTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <small class="text-muted ms-2">Loading reprocessing log...</small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
